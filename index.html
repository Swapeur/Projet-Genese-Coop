<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Projet Genèse</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-color: #050505; 
      --panel-bg: rgba(15, 15, 15, 0.95); 
      --border-color: #ffd700; 
      --text-color: #aaffaa; 
      --title-color: #ffd700; 
      --viral-green: #3fb950; 
      --viral-glow: rgba(63, 185, 80, 0.6); 
      --prestige-color: #ff4400; 
      --prestige-glow: rgba(255, 68, 0, 0.5); 
      --error-color: #ff0000; 
      --hazard-yellow: #ffd700;
      --hazard-black: #111;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body { 
      font-family: 'Share Tech Mono', monospace; 
      background-color: var(--bg-color); 
      background: radial-gradient(circle, #1a221a 0%, #000000 90%);
      color: var(--text-color); 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      height: 100vh;
      width: 100vw;
    }

    /* --- EFFET CRT / SCANLINES GLOBAL --- */
    #global-crt {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
      background-size: 100% 3px, 3px 100%;
      pointer-events: none; 
      z-index: 99999; 
      box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
    }

    h1, h2, h3, h4, p { margin: 0; padding: 0; }
    
    h1 { 
      color: var(--hazard-yellow); 
      border-bottom: 2px solid var(--hazard-yellow); 
      padding: 15px 0; 
      text-align: center; 
      font-size: 2.2em;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 2px;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 215, 0, 0.05) 10px, rgba(255, 215, 0, 0.05) 20px);
    }
    
    .container { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 10; }
    
    /* --- ZONE DE JEU --- */
    #game-area { 
      flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: space-around; height: 100%; 
      border-right: 4px solid var(--hazard-yellow); position: relative; z-index: 20; padding-top: 10px; padding-bottom: 10px;
    }

    /* --- MAGASIN --- */
    #store-area { 
      width: 380px; min-width: 380px; background-color: var(--panel-bg); height: 100%; overflow-y: auto; padding: 10px; 
      z-index: 20; display: flex; flex-direction: column; gap: 10px; border-left: 2px solid #000;
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: var(--hazard-yellow); border-radius: 0; }
    ::-webkit-scrollbar-thumb:hover { background: var(--viral-green); }

    /* --- LOGIN SÉCURISÉ (MODIFIÉ POUR AUTH) --- */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #login-box { 
      background: var(--panel-bg); border: 2px solid var(--hazard-yellow); padding: 40px; text-align: center; 
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); position: relative; width: 350px;
    }
    #login-box h2 { color: var(--hazard-yellow); margin-bottom: 20px; border: none; background: transparent; box-shadow: none; padding: 0; }
    
    .auth-input { padding: 10px; font-family: inherit; font-size: 1.1em; background: #000; border: 1px solid var(--hazard-yellow); color: var(--hazard-yellow); width: 100%; text-align: center; margin-bottom: 10px; outline: none; }
    .auth-input:focus { box-shadow: 0 0 10px var(--hazard-yellow); }
    .auth-btn { padding: 10px 20px; font-family: inherit; font-size: 1em; font-weight: bold; background: var(--hazard-yellow); border: none; color: #000; cursor: pointer; text-transform: uppercase; width: 48%; }
    .auth-btn:hover { background: #fff; box-shadow: 0 0 20px #fff; }
    .auth-btn.secondary { background: transparent; border: 1px solid var(--hazard-yellow); color: var(--hazard-yellow); }
    .auth-btn.secondary:hover { background: var(--hazard-yellow); color: #000; }
    #login-error { color: var(--error-color); margin-bottom: 10px; min-height: 20px; font-size: 0.9em; }

    /* --- INTRO (LORE) --- */
    #context-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 9000; display: none; 
      justify-content: center; align-items: center;
    }
    #context-box {
      width: 700px; max-width: 90%; background: rgba(10, 12, 10, 0.95); border-left: 4px solid var(--hazard-yellow); border-right: 4px solid var(--hazard-yellow);
      padding: 40px; box-shadow: 0 0 40px rgba(255, 215, 0, 0.15), inset 0 0 50px rgba(0,0,0,0.8); position: relative;
    }
    #context-text { color: #aaffaa; font-size: 1.1em; line-height: 1.6; min-height: 150px; white-space: pre-wrap; text-shadow: 0 0 2px var(--viral-green); }
    #start-mission-btn {
      margin-top: 30px; padding: 15px 30px; font-size: 1.2em; font-weight: bold; background: transparent; border: 2px solid var(--hazard-yellow); color: var(--hazard-yellow);
      cursor: pointer; width: 100%; font-family: inherit; transition: all 0.2s; display: none; text-transform: uppercase; letter-spacing: 1px;
    }
    #start-mission-btn:hover { background: var(--hazard-yellow); color: #000; box-shadow: 0 0 25px var(--hazard-yellow); }

    /* --- SCORE PANEL --- */
    .score-panel { 
      background-color: #000; border: 2px solid var(--viral-green); padding: 15px 40px; border-radius: 0; 
      box-shadow: 0 0 15px rgba(63, 185, 80, 0.2), inset 0 0 20px rgba(63, 185, 80, 0.1); text-align: center; position: relative;
    }
    #scoreDisplay { font-size: 3.5em; color: var(--viral-green); text-shadow: 0 0 10px var(--viral-glow); display: block; }
    #cps-display { color: var(--hazard-yellow); font-size: 1.5em; margin-top: 10px; font-weight: bold; }
    
    #player-count { 
      position: absolute; top: 15px; right: 20px; font-size: 1.2em; color: var(--hazard-yellow); font-weight: bold; 
      border: 1px solid var(--hazard-yellow); padding: 5px 10px; background: rgba(0,0,0,0.5);
    }

    #cell-button { 
      width: 220px; height: 220px; background: radial-gradient(circle, #1e3f20 0%, #000 80%); border-radius: 50%; border: 4px dashed var(--viral-green); 
      box-shadow: 0 0 30px rgba(63, 185, 80, 0.3), inset 0 0 50px rgba(0,0,0,1); cursor: pointer; transition: transform 0.05s, filter 0.2s; position: relative; z-index: 25; overflow: hidden;
    }
    #cell-button:hover { border-color: #fff; box-shadow: 0 0 50px var(--viral-green); }
    #cell-button:active { transform: scale(0.95); }
    #cell-button.clicked { animation: cellClickAnim 0.1s; }
    @keyframes cellClickAnim { 0% { transform: scale(0.95); } 100% { transform: scale(1); } }
    
    .ripple { position: absolute; border-radius: 50%; background: rgba(63, 185, 80, 0.8); transform: scale(0); animation: rippleAnim 0.6s linear; pointer-events: none; }
    @keyframes rippleAnim { to { transform: scale(2.5); opacity: 0; } }

    #click-info { margin-top: 15px; color: var(--text-color); font-size: 1.4em; text-align: center; font-weight: bold; text-shadow: 0 0 5px var(--viral-green); }
    .float-text { position: absolute; color: #fff; font-weight: bold; font-size: 1.4em; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 0 0 5px #000; z-index: 1000; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.3); } }

    #particle-container, #passive-particle-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }
    .particle { position: absolute; width: 8px; height: 8px; background: var(--viral-green); border-radius: 50%; animation: particleFly 1s forwards; opacity: 0; }
    .passive-particle { position: absolute; width: 4px; height: 4px; background: var(--viral-green); border-radius: 50%; animation: passiveFly 2s forwards; opacity: 0; }
    @keyframes particleFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }
    @keyframes passiveFly { 0% { opacity: 0.6; } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }
    .buy-particle { position: absolute; width: 8px; height: 8px; background: var(--hazard-yellow); box-shadow: 0 0 6px var(--hazard-yellow); border-radius: 50%; pointer-events: none; z-index: 9999; animation: buyExplosion 0.8s ease-out forwards; }
    @keyframes buyExplosion { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.5); } }

    /* --- MAGASIN STYLES --- */
    h2 { color: #000; background: var(--hazard-yellow); margin-bottom: 15px; margin-top: 10px; padding: 5px 10px; border-left: none; border-bottom: 2px solid #000; font-weight: bold; text-transform: uppercase; box-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
    .store-item { 
        background-color: rgba(20, 20, 20, 0.8); border: 1px solid #333; border-left: 3px solid #333; border-radius: 0; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s;
    }
    .store-item:hover { background-color: #000; border-color: var(--hazard-yellow); border-left: 5px solid var(--hazard-yellow); transform: translateX(5px); box-shadow: -5px 0 15px rgba(255, 215, 0, 0.2); }
    .store-item.purchased-anim { animation: flashGreen 0.3s; } 
    .store-item.error-anim { animation: shakeRed 0.3s; }
    
    .item-info h3 { font-size: 1em; color: var(--hazard-yellow); margin-bottom: 2px; } 
    .item-desc { font-size: 0.8em; color: #888; font-style: normal; } 
    .item-gain { font-size: 0.85em; color: var(--viral-green); font-weight: bold; }
    .item-stats { text-align: right; min-width: 80px; } 
    .item-cost { display: block; font-size: 1em; color: #fff; font-weight: bold; } 
    .item-count { display: block; font-size: 1.4em; color: var(--hazard-yellow); font-weight: bold; margin-top: 2px; }

    /* --- TOOLTIP --- */
    #tooltip { display: none; position: absolute; background: rgba(0,0,0,0.95); border: 1px solid var(--hazard-yellow); padding: 10px; width: 250px; z-index: 999999; pointer-events: none; box-shadow: 0 5px 20px #000; }
    #tooltip h4 { color: var(--hazard-yellow); margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px dashed #555; padding-bottom: 5px; } 
    #tooltip .cost { color: #fff; font-weight: bold; margin-bottom: 5px; } 
    #tooltip .desc { color: #aaa; font-size: 0.9em; } 
    #tooltip .stats { margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; font-size: 0.85em; color: var(--viral-green); }

    /* --- CHAT --- */
    #chat-container { position: absolute; bottom: 10px; left: 10px; width: 320px; height: 230px; background: rgba(0, 0, 0, 0.9); border: 1px solid var(--border-color); border-radius: 0; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; }
    #chat-header { padding: 5px; border-bottom: 1px solid var(--border-color); background: var(--hazard-yellow); color: #000; font-size: 0.9em; font-weight: bold; text-transform: uppercase; }
    #chat-messages { flex-grow: 1; overflow-y: auto; padding: 8px; font-size: 0.85em; display: flex; flex-direction: column; gap: 4px; scrollbar-width: thin; scrollbar-color: var(--hazard-yellow) #000; }
    .msg { word-wrap: break-word; border-left: 2px solid #333; padding-left: 5px; } 
    .msg-user { color: var(--hazard-yellow); font-weight: bold; } 
    .msg-text { color: #ddd; } 
    #chat-form { display: flex; border-top: 1px solid var(--border-color); }
    #chat-input { flex-grow: 1; background: #111; border: none; padding: 8px; color: var(--hazard-yellow); font-family: inherit; outline: none; }
    #chat-btn { background: #222; border: none; border-left: 1px solid var(--border-color); color: var(--hazard-yellow); padding: 0 10px; cursor: pointer; font-family: inherit; }

    /* --- LEADERBOARD --- */
    #leaderboard-panel { position: absolute; top: 80px; left: 20px; width: 200px; background: rgba(0, 0, 0, 0.8); border: 1px solid var(--hazard-yellow); border-radius: 0; padding: 10px; z-index: 50; pointer-events: none; }
    #leaderboard-panel h3 { font-size: 1em; color: var(--hazard-yellow); margin-bottom: 5px; text-align: center; border-bottom: 1px dashed #333; padding-bottom: 5px; background: transparent; box-shadow: none; }
    #leaderboard-list { list-style: none; padding: 0; margin: 0; font-size: 0.85em; }
    #leaderboard-list li { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #222; }
    .lb-name { color: #fff; font-weight: bold; } .lb-score { color: var(--viral-green); }

    @keyframes flashGreen { 0% { background-color: var(--viral-green); } 100% { background-color: rgba(20, 20, 20, 0.8); } } 
    @keyframes shakeRed { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); border-color: var(--error-color); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    
    /* --- HUD BUTTONS (Settings) --- */
    .hud-btn { position: absolute; top: 15px; width: 45px; height: 45px; background: #000; border: 1px solid var(--hazard-yellow); display: flex; justify-content: center; align-items: center; cursor: pointer; z-index: 100; box-shadow: 0 0 10px rgba(255, 215, 0, 0.1); transition: all 0.2s ease; }
    #settings-btn { left: 15px; }
    .hud-btn:hover { border-color: var(--viral-green); box-shadow: 0 0 15px var(--viral-green); }
    .hud-btn svg { width: 24px; height: 24px; fill: var(--hazard-yellow); }
    .hud-btn:hover svg { fill: var(--viral-green); }
    
    #bio-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.3; }
  </style>
</head>
<body>
  <div id="global-crt"></div>

  <div id="login-overlay">
    <div id="login-box">
      <h2>IDENTIFICATION REQUISE</h2>
      <p style="color: #aaa; margin-bottom: 20px;">Accès au Laboratoire</p>
      <div id="login-error"></div>
      <form id="auth-form">
        <input type="text" id="username" class="auth-input" placeholder="Nom de Code" required autocomplete="off">
        <input type="password" id="password" class="auth-input" placeholder="Mot de passe" required>
        <div style="display:flex; justify-content: space-between; gap:10px;">
            <button type="submit" class="auth-btn">CONNEXION</button>
            <button type="button" id="btn-register" class="auth-btn secondary">CRÉER</button>
        </div>
      </form>
    </div>
  </div>

  <div id="context-overlay">
    <div id="context-box">
      <h2>☣_ TRANSMISSION SÉCURISÉE</h2>
      <div id="context-text"></div>
      <button id="start-mission-btn">ACCEPTER LE PROTOCOLE</button>
    </div>
  </div>
  
  <canvas id="bio-canvas"></canvas>

  <div id="passive-particle-container"></div>
  <div class="container">
    <div id="game-area">
      <div id="settings-btn" class="hud-btn" onclick="if(confirm('Se déconnecter ?')) logout();" title="Déconnexion">
        <svg viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5a2 2 0 0 0-2 2v4h2V5h14v14H5v-4H3v4a2 2 0 0 0 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
      </div>
      
      <h1>☣ Projet : Genèse ☣</h1><div id="player-count">SCIENTIFIQUES : 0</div>
      <div class="score-panel"><div id="scoreDisplay">0</div><p class="score-label">Cellules Infectées</p><div id="cps-display">+0 CI/s</div></div>
      <div id="leaderboard-panel"><h3>Top Contagion</h3><ul id="leaderboard-list"></ul></div>
      <div id="cell-button"></div><div id="click-info">PUISSANCE: +1</div> 
      <div id="particle-container"></div>
      <div id="chat-container"><div id="chat-header">ID: <span id="current-username-display">Anonyme</span></div><div id="chat-messages"><div class="msg"><span class="msg-user">SYSTÈME:</span> <span class="msg-text">Connexion établie.</span></div></div><form id="chat-form"><input type="text" id="chat-input" placeholder="Message..." autocomplete="off"><button type="submit" id="chat-btn">></button></form></div>
      
    </div>
    <div id="store-area">
      <h2>AMÉLIORATIONS</h2>
      
      <div class="store-item" id="b-mutation"><div class="item-info"><h3>Mutation Mineure</h3><p class="item-desc">Tiens ? Un troisième bras a poussé.</p><p class="item-gain">+0.1 CI/s</p></div><div class="item-stats"><span class="item-cost">15</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-oiseau"><div class="item-info"><h3>Vecteur Oiseau</h3><p class="item-desc">Roucoule, tousse, propage, répète.</p><p class="item-gain">+1 CI/s</p></div><div class="item-stats"><span class="item-cost">100</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-eau"><div class="item-info"><h3>Contamination Eau</h3><p class="item-desc">Enrichie en minéraux et en pathogènes.</p><p class="item-gain">+8 CI/s</p></div><div class="item-stats"><span class="item-cost">1100</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-aerosol"><div class="item-info"><h3>Transmission Aérosol</h3><p class="item-desc">L'amour est dans l'air. La mort aussi.</p><p class="item-gain">+47 CI/s</p></div><div class="item-stats"><span class="item-cost">12000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-aeroport"><div class="item-info"><h3>Aéroport International</h3><p class="item-desc">Tour du monde en 80 fièvres.</p><p class="item-gain">+260 CI/s</p></div><div class="item-stats"><span class="item-cost">130000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-ferme"><div class="item-info"><h3>Fermes Virales</h3><p class="item-desc">Élevé en plein air, mort en plein air.</p><p class="item-gain">+2k CI/s</p></div><div class="item-stats"><span class="item-cost">500000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-centre"><div class="item-info"><h3>Centres de Contagion</h3><p class="item-desc">La promiscuité, c'est l'avenir de l'espèce.</p><p class="item-gain">+15k CI/s</p></div><div class="item-stats"><span class="item-cost">5M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-propagande"><div class="item-info"><h3>Propagande Virale</h3><p class="item-desc">"Ne paniquez pas, c'est juste une allergie."</p><p class="item-gain">+100k CI/s</p></div><div class="item-stats"><span class="item-cost">50M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-satellite"><div class="item-info"><h3>Satellite de Dispersion</h3><p class="item-desc">Prévisions météo : averses de spores.</p><p class="item-gain">+1.2M CI/s</p></div><div class="item-stats"><span class="item-cost">600M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-clonage"><div class="item-info"><h3>Clonage Humain</h3><p class="item-desc">On ne manque plus de volontaires pour les tests.</p><p class="item-gain">+20M CI/s</p></div><div class="item-stats"><span class="item-cost">7.5Md</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-terraformation"><div class="item-info"><h3>Terraformation Virale</h3><p class="item-desc">Une planète verte... de pus et de nécrose.</p><p class="item-gain">+350M CI/s</p></div><div class="item-stats"><span class="item-cost">95Md</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-singularite"><div class="item-info"><h3>Singularité Biologique</h3><p class="item-desc">Toute la biomasse fusionnée en une seule entité.</p><p class="item-gain">+8Md CI/s</p></div><div class="item-stats"><span class="item-cost">1.5Tn</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-echo"><div class="item-info"><h3>Échos Dimensionnels</h3><p class="item-desc">La membrane de la réalité commence à tousser.</p><p class="item-gain">+50Md CI/s</p></div><div class="item-stats"><span class="item-cost">10Tn</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-nano"><div class="item-info"><h3>Nanobots</h3><p class="item-desc">Des virus synthétiques qui n'arrêtent jamais.</p><p class="item-gain">+1.5Tn CI/s</p></div><div class="item-stats"><span class="item-cost">250Tn</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-nova"><div class="item-info"><h3>Supernova Virale</h3><p class="item-desc">L'univers entier est notre boîte de Petri.</p><p class="item-gain">+100Qa CI/s</p></div><div class="item-stats"><span class="item-cost">8Qa</span><span class="item-count">0</span></div></div>

    </div>
  </div>
  <div id="tooltip"></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // --- VARIABLES SESSION ---
    let socket = null;
    const sessionStartTime = Date.now();
    let lastState = null;

    // --- AUDIO SYSTEM (Original Restored) ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const Sound = {
      click: () => { 
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; 
        osc.frequency.setValueAtTime(400, audioCtx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15); 
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.15); 
      },
      buy: () => { 
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(200, audioCtx.currentTime); 
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); 
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
      },
      chat: () => { 
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; 
        osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
      }
    };

    // --- AUTHENTIFICATION (Injection) ---
    const loginOverlay = document.getElementById('login-overlay');
    const authForm = document.getElementById('auth-form');
    const errorDiv = document.getElementById('login-error');
    
    const savedToken = localStorage.getItem('viral_token');
    if(savedToken) attemptConnection(savedToken);

    document.getElementById('btn-register').onclick = () => doAuth('/api/register');
    authForm.onsubmit = (e) => { e.preventDefault(); doAuth('/api/login'); };

    async function doAuth(endpoint) {
        const user = document.getElementById('username').value.trim();
        const pass = document.getElementById('password').value.trim();
        if(!user || !pass) return;
        try {
            const res = await fetch(endpoint, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({username: user, password: pass})
            });
            const data = await res.json();
            if(data.error) errorDiv.innerText = "⚠️ " + data.error;
            else {
                localStorage.setItem('viral_token', data.token);
                localStorage.setItem('viral_username', data.username);
                attemptConnection(data.token);
            }
        } catch(e) { errorDiv.innerText = "Erreur serveur."; }
    }

    function attemptConnection(token) {
        socket = io({ auth: { token: token } });
        
        socket.on("connect_error", () => { logout(); });
        socket.on("connect", () => {
            loginOverlay.style.display = 'none';
            document.getElementById('current-username-display').innerText = localStorage.getItem('viral_username');
            launchContextSequence();
        });
        
        // LISTENERS JEU (Originaux rétablis)
        socket.on('tick_update', (d) => { 
            lastState = d; // Sync for animation loop
            document.getElementById('scoreDisplay').innerText = Math.floor(d.score).toLocaleString(); 
            document.getElementById('cps-display').innerText = '+' + Math.floor(d.cps).toLocaleString() + ' CI/s'; 
            document.getElementById('player-count').innerText = 'SCIENTIFIQUES : ' + d.players;
            document.getElementById('click-info').innerText = 'PUISSANCE: +' + Math.floor(d.clickValue).toLocaleString();
            
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';
            d.leaderboard.forEach(p => {
                const li = document.createElement('li');
                li.innerHTML = `<span class="lb-name">${p.name}</span> <span class="lb-score">${Math.floor(p.contribution)}</span>`;
                list.appendChild(li);
            });
        });

        socket.on('full_update', (d) => {
            const s = d.gameState;
            lastState = { ...d, ...s }; // Merge for safety
            
            // UPDATE DES BOUTONS MAGASIN (Legacy IDs)
            const updateBtn = (id, cost, count) => {
                const el = document.getElementById(id);
                if(el) {
                    el.querySelector('.item-cost').innerText = Math.floor(cost).toLocaleString();
                    el.querySelector('.item-count').innerText = count;
                    if(s.totalInfectedCells >= cost) el.style.opacity = 1; else el.style.opacity = 0.5;
                }
            };
            
            updateBtn('b-mutation', s.cost_mutation, s.mutations_mineures);
            updateBtn('b-oiseau', s.cost_oiseau, s.vecteurs_oiseaux);
            updateBtn('b-eau', s.cost_eau, s.contamination_eau);
            updateBtn('b-aerosol', s.cost_aerosol, s.transmission_aerosol);
            updateBtn('b-aeroport', s.cost_aeroport, s.aeroport_international);
            updateBtn('b-ferme', s.cost_ferme, s.fermes_virales);
            updateBtn('b-centre', s.cost_centre, s.centres_contagion);
            updateBtn('b-propagande', s.cost_propagande, s.propagande_virale);
            updateBtn('b-satellite', s.cost_satellite, s.satellite_dispersion);
            updateBtn('b-clonage', s.cost_clonage, s.clonage_humain);
            updateBtn('b-terraformation', s.cost_terraformation, s.terraformation_virale);
            updateBtn('b-singularite', s.cost_singularite, s.singularite_biologique);
            updateBtn('b-echo', s.cost_echo, s.echos_dimensionnels);
            updateBtn('b-nano', s.cost_nano, s.nanobots_autoreplicants);
            updateBtn('b-nova', s.cost_nova, s.supernova_virale);
        });
    }

    function logout() {
        localStorage.removeItem('viral_token');
        localStorage.removeItem('viral_username');
        location.reload();
    }

    // --- INTERACTION JEU (Original) ---
    const cellBtn = document.getElementById('cell-button');
    cellBtn.onclick = (e) => {
        if(!e.isTrusted || !socket) return;
        socket.emit('click_cell');
        Sound.click();
        
        // Ripple FX
        const ripple = document.createElement('div'); ripple.className = 'ripple';
        const rect = cellBtn.getBoundingClientRect();
        ripple.style.width = ripple.style.height = rect.width + 'px';
        ripple.style.left = (e.clientX - rect.left - rect.width/2) + 'px';
        ripple.style.top = (e.clientY - rect.top - rect.height/2) + 'px';
        cellBtn.appendChild(ripple); setTimeout(() => ripple.remove(), 600);
        
        cellBtn.classList.add('clicked'); setTimeout(()=>cellBtn.classList.remove('clicked'),100);
        spawnFloatingText(e, "+?"); // Value updated by server tick
        spawnParticle(cellBtn, 5);
    };

    // --- CLICK HANDLERS MAGASIN (Mapping Legacy -> Server Secure) ---
    const binds = {
        'b-mutation': 'mutation_mineure', 'b-oiseau': 'vecteur_oiseau', 'b-eau': 'contamination_eau',
        'b-aerosol': 'transmission_aerosol', 'b-aeroport': 'aeroport_international', 'b-ferme': 'fermes_virales',
        'b-centre': 'centres_contagion', 'b-propagande': 'propagande_virale', 'b-satellite': 'satellite_dispersion',
        'b-clonage': 'clonage_humain', 'b-terraformation': 'terraformation_virale', 'b-singularite': 'singularite_biologique',
        'b-echo': 'echos_dimensionnels', 'b-nano': 'nanobots_autoreplicants', 'b-nova': 'supernova_virale'
    };
    for(const [btnId, serverId] of Object.entries(binds)) {
        const el = document.getElementById(btnId);
        el.onclick = () => {
             if(socket) { socket.emit('buy_upgrade', serverId); Sound.buy(); }
        };
    }

    // --- PARTICLES & FX (Keep Original) ---
    const partCont = document.getElementById('particle-container');
    function spawnParticle(src, n) {
        const rect = src.getBoundingClientRect();
        for(let i=0; i<n; i++) {
            const p = document.createElement('div'); p.className = 'particle';
            const s = Math.random()*8+4; p.style.width=s+'px'; p.style.height=s+'px';
            p.style.left = (rect.left + rect.width/2)+'px'; p.style.top = (rect.top + rect.height/2)+'px';
            const tx = (Math.random()-0.5)*200; const ty = (Math.random()-0.5)*200;
            p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px');
            partCont.appendChild(p); setTimeout(()=>p.remove(), 1000);
        }
    }
    function spawnFloatingText(e, txt) {
        const el = document.createElement('div'); el.className = 'float-text'; el.innerText = txt;
        el.style.left = e.clientX + 'px'; el.style.top = e.clientY + 'px';
        document.body.appendChild(el); setTimeout(() => el.remove(), 800);
    }

    // --- INTRO & CHAT ---
    const BRIEFING = "IDENTIFICATION CONFIRMÉE.\nBienvenue dans le Projet Genèse.";
    function launchContextSequence() {
        const overlay = document.getElementById('context-overlay');
        const txt = document.getElementById('context-text');
        const btn = document.getElementById('start-mission-btn');
        
        // Si l'utilisateur a déjà vu l'intro (optionnel, ici on affiche si token nouveau)
        overlay.style.display = 'flex';
        txt.innerText = BRIEFING;
        btn.style.display = 'block';
        btn.onclick = () => { overlay.style.display = 'none'; Sound.buy(); };
    }

    const chatForm = document.getElementById('chat-form');
    chatForm.onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('chat-input');
        if(!input.value) return;
        fetch('/api/chat', {
            method:'POST', 
            headers: {'Content-Type':'application/json', 'Authorization': 'Bearer '+localStorage.getItem('viral_token')},
            body: JSON.stringify({text: input.value})
        }).then(()=>input.value='');
    }
    // Polling chat
    setInterval(() => {
        fetch('/api/chat').then(r=>r.json()).then(msgs => {
            const box = document.getElementById('chat-messages');
            box.innerHTML = ''; // Simplifié pour l'exemple
            msgs.forEach(m => {
                box.innerHTML += `<div class="msg"><span class="msg-user">${m.user}:</span> <span class="msg-text">${m.text}</span></div>`;
            });
        });
    }, 3000);

    // --- BACKGROUND CANVAS ---
    (function initBioBackground() {
      const canvas = document.getElementById('bio-canvas'); const ctx = canvas.getContext('2d');
      let w, h; const particles = [];
      function resize() { w = canvas.width = window.innerWidth; h = canvas.height = window.innerHeight; }
      window.addEventListener('resize', resize); resize();
      class P {
        constructor() { this.x=Math.random()*w; this.y=Math.random()*h; this.vx=(Math.random()-0.5)*0.5; this.vy=(Math.random()-0.5)*0.5; this.r=Math.random()*15+5; this.a=Math.random()*0.1+0.05; }
        update() { this.x+=this.vx; this.y+=this.vy; if(this.x<0||this.x>w) this.vx*=-1; if(this.y<0||this.y>h) this.vy*=-1; }
        draw() { ctx.beginPath(); ctx.arc(this.x,this.y,this.r,0,6.28); ctx.fillStyle=`rgba(63,185,80,${this.a})`; ctx.fill(); }
      }
      for(let i=0; i<40; i++) particles.push(new P());
      function anim() { ctx.clearRect(0,0,w,h); particles.forEach(p=>{p.update();p.draw();}); requestAnimationFrame(anim); }
      anim();
    })();
  </script>
</body>
</html>