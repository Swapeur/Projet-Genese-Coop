<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Projet Gen√®se</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root { 
      --bg-color: #050505; 
      --panel-bg: rgba(15, 15, 15, 0.95); 
      --border-color: #ffd700; 
      --text-color: #aaffaa; 
      --title-color: #ffd700; 
      --viral-green: #3fb950; 
      --viral-glow: rgba(63, 185, 80, 0.6); 
      --prestige-color: #ff4400; 
      --prestige-glow: rgba(255, 68, 0, 0.5); 
      --error-color: #ff0000; 
      --hazard-yellow: #ffd700;
      --hazard-black: #111;
    }
    
    * { box-sizing: border-box; user-select: none; }
    
    body { 
      font-family: 'Share Tech Mono', monospace; 
      background-color: var(--bg-color); 
      background: radial-gradient(circle, #1a221a 0%, #000000 90%);
      color: var(--text-color); 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      height: 100vh;
      width: 100vw;
    }

    /* --- EFFET CRT / SCANLINES GLOBAL --- */
    #global-crt {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.03), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.03));
      background-size: 100% 3px, 3px 100%;
      pointer-events: none; /* Important pour pouvoir cliquer au travers */
      z-index: 99999; 
      box-shadow: inset 0 0 100px rgba(0,0,0,0.9);
    }

    h1, h2, h3, h4, p { margin: 0; padding: 0; }
    
    h1 { 
      color: var(--hazard-yellow); 
      border-bottom: 2px solid var(--hazard-yellow); 
      padding: 15px 0; 
      text-align: center; 
      font-size: 2.2em;
      text-shadow: 0 0 10px rgba(255, 215, 0, 0.4);
      text-transform: uppercase;
      letter-spacing: 2px;
      background: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255, 215, 0, 0.05) 10px, rgba(255, 215, 0, 0.05) 20px);
    }
    
    .container { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 10; }
    
    /* --- ZONE DE JEU --- */
    #game-area { 
      flex-grow: 1; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: space-around; 
      height: 100%; 
      border-right: 4px solid var(--hazard-yellow); 
      position: relative; 
      z-index: 20; 
      padding-top: 10px; 
      padding-bottom: 10px;
    }

    /* --- MAGASIN --- */
    #store-area { 
      width: 380px; 
      min-width: 380px; 
      background-color: var(--panel-bg); 
      height: 100%; 
      overflow-y: auto; 
      padding: 10px; 
      z-index: 20; 
      display: flex; 
      flex-direction: column; 
      gap: 10px; 
      border-left: 2px solid #000;
    }
    
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: var(--hazard-yellow); border-radius: 0; }
    ::-webkit-scrollbar-thumb:hover { background: var(--viral-green); }

    /* --- LOGIN --- */
    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: #000; z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    
    #login-box { 
      background: var(--panel-bg); 
      border: 2px solid var(--hazard-yellow); 
      padding: 40px; 
      text-align: center; 
      box-shadow: 0 0 50px rgba(255, 215, 0, 0.2);
      position: relative;
    }
    #login-box::before { content:''; position:absolute; top:0; left:0; width:100%; height:10px; background: repeating-linear-gradient(45deg, var(--hazard-yellow), var(--hazard-yellow) 10px, #000 10px, #000 20px); }
    #login-box::after { content:''; position:absolute; bottom:0; left:0; width:100%; height:10px; background: repeating-linear-gradient(45deg, var(--hazard-yellow), var(--hazard-yellow) 10px, #000 10px, #000 20px); }

    #login-box h2 { 
        color: var(--hazard-yellow); 
        margin-bottom: 20px; 
        border: none; 
        background: transparent; 
        box-shadow: none; 
        padding: 0;
    }
    
    #login-input { padding: 10px; font-family: inherit; font-size: 1.2em; background: #000; border: 1px solid var(--hazard-yellow); color: var(--hazard-yellow); width: 250px; text-align: center; margin-bottom: 20px; outline: none; }
    #login-input:focus { box-shadow: 0 0 10px var(--hazard-yellow); }
    #login-btn { padding: 10px 30px; font-family: inherit; font-size: 1.2em; font-weight: bold; background: var(--hazard-yellow); border: none; color: #000; cursor: pointer; text-transform: uppercase; }
    #login-btn:hover { background: #fff; box-shadow: 0 0 20px #fff; }

    /* --- INTRO (LORE) --- */
    #context-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background-color: #000;
      z-index: 9000; 
      display: none; 
      justify-content: center; align-items: center;
    }
    #context-box {
      width: 700px; max-width: 90%;
      background: rgba(10, 12, 10, 0.95);
      border-left: 4px solid var(--hazard-yellow);
      border-right: 4px solid var(--hazard-yellow);
      padding: 40px;
      box-shadow: 0 0 40px rgba(255, 215, 0, 0.15), inset 0 0 50px rgba(0,0,0,0.8);
      position: relative;
    }
    #context-box::before, #context-box::after {
      content: ''; position: absolute; left: 0; width: 100%; height: 15px;
      background: repeating-linear-gradient(45deg, var(--hazard-yellow), var(--hazard-yellow) 15px, #000 15px, #000 30px);
    }
    #context-box::before { top: 0; } #context-box::after { bottom: 0; }

    #context-box h2 {
      color: var(--hazard-yellow); font-size: 1.5em; margin-bottom: 20px; margin-top: 10px;
      border-bottom: 1px dashed var(--hazard-yellow); padding-bottom: 10px; text-align: left; border-left: none; padding-left: 0;
      background: transparent; box-shadow: none; 
    }
    
    #context-text { color: #aaffaa; font-size: 1.1em; line-height: 1.6; min-height: 150px; white-space: pre-wrap; text-shadow: 0 0 2px var(--viral-green); }
    #start-mission-btn {
      margin-top: 30px; padding: 15px 30px; font-size: 1.2em; font-weight: bold;
      background: transparent; border: 2px solid var(--hazard-yellow); color: var(--hazard-yellow);
      cursor: pointer; width: 100%; font-family: inherit; transition: all 0.2s; display: none; text-transform: uppercase; letter-spacing: 1px;
    }
    #start-mission-btn:hover { background: var(--hazard-yellow); color: #000; box-shadow: 0 0 25px var(--hazard-yellow); }

    /* --- SIGNATURE --- */
    #signature {
      position: absolute; bottom: 10px; right: 15px;
      font-size: 0.8em; color: var(--hazard-yellow); opacity: 0.5;
      font-weight: bold; letter-spacing: 1px; pointer-events: none; z-index: 10;
      text-shadow: 0 0 5px rgba(0,0,0,0.8);
    }

    /* --- CANVAS FOND --- */
    #bio-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; pointer-events: none; opacity: 0.3; }

    /* --- SCORE PANEL --- */
    .score-panel { 
      background-color: #000; 
      border: 2px solid var(--viral-green); 
      padding: 15px 40px; 
      border-radius: 0; 
      box-shadow: 0 0 15px rgba(63, 185, 80, 0.2), inset 0 0 20px rgba(63, 185, 80, 0.1);
      text-align: center; 
      position: relative;
    }
    .score-panel::after { content: ''; position: absolute; top: -2px; left: -2px; width: 10px; height: 10px; border-top: 2px solid var(--hazard-yellow); border-left: 2px solid var(--hazard-yellow); }
    .score-panel::before { content: ''; position: absolute; bottom: -2px; right: -2px; width: 10px; height: 10px; border-bottom: 2px solid var(--hazard-yellow); border-right: 2px solid var(--hazard-yellow); }

    #scoreDisplay { 
      font-size: 3.5em; color: var(--viral-green); 
      text-shadow: 0 0 10px var(--viral-glow);
      font-variant-numeric: tabular-nums; transition: transform 0.1s; display: block; 
    }
    #scoreDisplay.pop { transform: scale(1.1); color: #fff; text-shadow: 0 0 20px #fff; }
    .score-label { font-size: 1.2em; margin-top: 5px; color: #666; text-transform: uppercase; letter-spacing: 2px; }
    #cps-display { color: var(--hazard-yellow); font-size: 1.5em; margin-top: 10px; font-weight: bold; }
    
    #player-count { 
      position: absolute; top: 15px; right: 20px; 
      font-size: 1.2em; color: var(--hazard-yellow); 
      font-weight: bold; text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
      border: 1px solid var(--hazard-yellow); padding: 5px 10px;
      background: rgba(0,0,0,0.5);
    }

    #cell-button { 
      width: 220px; height: 220px; 
      background: radial-gradient(circle, #1e3f20 0%, #000 80%); 
      border-radius: 50%; 
      border: 4px dashed var(--viral-green); 
      box-shadow: 0 0 30px rgba(63, 185, 80, 0.3), inset 0 0 50px rgba(0,0,0,1); 
      cursor: pointer; transition: transform 0.05s, filter 0.2s; 
      position: relative; z-index: 25; overflow: hidden;
    }
    #cell-button:hover { border-color: #fff; box-shadow: 0 0 50px var(--viral-green); }
    #cell-button:active { transform: scale(0.95); }
    #cell-button.clicked { animation: cellClickAnim 0.1s; }
    @keyframes cellClickAnim { 0% { transform: scale(0.95); } 100% { transform: scale(1); } }
    
    .ripple { position: absolute; border-radius: 50%; background: rgba(63, 185, 80, 0.8); transform: scale(0); animation: rippleAnim 0.6s linear; pointer-events: none; }
    @keyframes rippleAnim { to { transform: scale(2.5); opacity: 0; } }

    #click-info { 
      margin-top: 15px; color: var(--text-color); font-size: 1.4em; 
      text-align: center; font-weight: bold; 
      text-shadow: 0 0 5px var(--viral-green);
    }

    .float-text { position: absolute; color: #fff; font-weight: bold; font-size: 1.4em; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 0 0 5px #000; z-index: 1000; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.3); } }

    #particle-container, #passive-particle-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }
    .particle { position: absolute; width: 8px; height: 8px; background: var(--viral-green); border-radius: 50%; animation: particleFly 1s forwards; opacity: 0; }
    .passive-particle { position: absolute; width: 4px; height: 4px; background: var(--viral-green); border-radius: 50%; animation: passiveFly 2s forwards; opacity: 0; }
    @keyframes particleFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }
    @keyframes passiveFly { 0% { opacity: 0.6; } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }
    .buy-particle { position: absolute; width: 8px; height: 8px; background: var(--hazard-yellow); box-shadow: 0 0 6px var(--hazard-yellow); border-radius: 50%; pointer-events: none; z-index: 9999; animation: buyExplosion 0.8s ease-out forwards; }
    @keyframes buyExplosion { 0% { opacity: 1; transform: translate(0, 0) scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)) scale(0.5); } }

    .bonus-mutation { position: absolute; font-size: 4em; cursor: pointer; filter: drop-shadow(0 0 10px var(--error-color)); animation: pulseBonus 0.5s infinite alternate, popIn 0.3s ease-out; z-index: 1000; user-select: none; }
    @keyframes pulseBonus { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    /* --- TITRES SECTION MAGASIN (STYLE PAR D√âFAUT) --- */
    h2 { 
      color: #000; 
      background: var(--hazard-yellow);
      margin-bottom: 15px; margin-top: 10px; padding: 5px 10px; 
      border-left: none; border-bottom: 2px solid #000;
      font-weight: bold; text-transform: uppercase;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.3);
    }
    
    /* --- ITEMS MAGASIN --- */
    .store-item { 
        background-color: rgba(20, 20, 20, 0.8); 
        border: 1px solid #333; 
        border-left: 3px solid #333;
        border-radius: 0; 
        padding: 12px; cursor: pointer; display: none; 
        justify-content: space-between; align-items: center; 
        transition: all 0.2s;
    }
    .store-item.revealed { display: flex; animation: fadeIn 0.5s; }
    .store-item:hover { 
        background-color: #000; 
        border-color: var(--hazard-yellow); 
        border-left: 5px solid var(--hazard-yellow);
        transform: translateX(5px); 
        box-shadow: -5px 0 15px rgba(255, 215, 0, 0.2);
    }
    .store-item.purchased-anim { animation: flashGreen 0.3s; } .store-item.error-anim { animation: shakeRed 0.3s; }
    
    .item-info h3 { font-size: 1em; color: var(--hazard-yellow); margin-bottom: 2px; } 
    .item-desc { font-size: 0.8em; color: #888; font-style: normal; } 
    .item-gain { font-size: 0.85em; color: var(--viral-green); font-weight: bold; }
    .item-stats { text-align: right; min-width: 80px; } 
    .item-cost { display: block; font-size: 1em; color: #fff; font-weight: bold; } 
    .item-count { display: block; font-size: 1.4em; color: var(--hazard-yellow); font-weight: bold; margin-top: 2px; }

    /* --- BOOSTS --- */
    #boost-area { 
        background: #000; border: 1px solid var(--border-color); border-radius: 0; 
        padding: 15px; min-height: 80px; margin-bottom: 25px; 
        display: flex; flex-direction: column; gap: 10px;
        position: relative;
    }
    #boost-area::before {
        content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px;
        background: repeating-linear-gradient(90deg, var(--hazard-yellow), var(--hazard-yellow) 10px, #000 10px, #000 20px);
    }
    #boost-area h3 {
        font-size: 1.1em; color: var(--hazard-yellow); margin-bottom: 5px; border: none; padding-bottom: 0;
        background: transparent; box-shadow: none; /* Override du style global h2 */
    }
    #boost-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .boost-item { 
        width: 45px; height: 45px; background: #111; border: 1px solid var(--hazard-yellow); 
        border-radius: 0; display: flex; align-items: center; justify-content: center; 
        font-size: 1.5em; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; 
        color: var(--hazard-yellow);
    }
    .boost-item:hover { transform: scale(1.1); background: var(--hazard-yellow); color: #000; box-shadow: 0 0 10px var(--hazard-yellow); }

    /* --- PRESTIGE --- */
    #prestige-area { display: none; background: #1a0500; border: 1px solid var(--prestige-color); padding: 10px; text-align: center; margin-bottom: 15px; }
    #prestige-area h3 { color: var(--prestige-color); background: transparent; box-shadow: none; }
    .prestige-btn { 
        background: transparent; color: var(--prestige-color); 
        border: 1px solid var(--prestige-color); 
        padding: 8px; width: 100%; border-radius: 0; 
        cursor: pointer; font-weight: bold; margin-top: 5px; font-family: inherit; 
        text-transform: uppercase;
    }
    .prestige-btn:hover { background: var(--prestige-color); color: #000; box-shadow: 0 0 15px var(--prestige-color); } 
    .prestige-btn.secondary { border-color: var(--hazard-yellow); color: var(--hazard-yellow); }
    .prestige-btn.secondary:hover { background: var(--hazard-yellow); color: #000; box-shadow: 0 0 15px var(--hazard-yellow); }

    /* --- MODALES COMMUNES (Settings, Stats, Meta) --- */
    .modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 5000; justify-content: center; align-items: center; }
    .modal-content { width: 600px; max-width: 95%; max-height: 80vh; background: #0d1117; border: 2px solid var(--hazard-yellow); border-radius: 0; display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(255, 215, 0, 0.2); }
    .modal-header { padding: 15px; border-bottom: 2px solid var(--hazard-yellow); text-align: center; background: repeating-linear-gradient(45deg, #111, #111 10px, #222 10px, #222 20px); }
    .modal-header h2 { color: var(--hazard-yellow); background: none; border: none; box-shadow: none; padding: 0; margin: 0; font-size: 1.5em; }
    .modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
    
    .close-btn { margin-top: 10px; padding: 12px; background: var(--hazard-yellow); border: none; color: #000; font-weight: bold; font-family: inherit; cursor: pointer; text-transform: uppercase; width: 100%; }
    .close-btn:hover { background: #fff; }

    /* --- CONTENU SPECIFIQUE MODALES --- */
    .p-upgrade { background: #111; border: 1px solid #333; padding: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .p-upgrade:hover { border-color: var(--hazard-yellow); background: #222; }
    .p-upgrade.purchased { border-color: var(--viral-green); opacity: 0.6; }
    .p-upgrade h4 { color: #fff; } .p-upgrade .cost { color: var(--hazard-yellow); font-weight: bold; }

    /* --- TOOLTIP --- */
    #tooltip { 
        display: none; position: absolute; background: rgba(0,0,0,0.95); 
        border: 1px solid var(--hazard-yellow); padding: 10px; width: 250px; 
        z-index: 999999; pointer-events: none; box-shadow: 0 5px 20px #000; 
    }
    #tooltip h4 { color: var(--hazard-yellow); margin-bottom: 5px; text-transform: uppercase; border-bottom: 1px dashed #555; padding-bottom: 5px; } 
    #tooltip .cost { color: #fff; font-weight: bold; margin-bottom: 5px; } 
    #tooltip .desc { color: #aaa; font-size: 0.9em; } 
    #tooltip .stats { margin-top: 5px; border-top: 1px solid #333; padding-top: 5px; font-size: 0.85em; color: var(--viral-green); }

    /* --- CHAT --- */
    #chat-container { 
        position: absolute; bottom: 10px; left: 10px; width: 320px; height: 230px; 
        background: rgba(0, 0, 0, 0.9); border: 1px solid var(--border-color); 
        border-radius: 0; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; 
    }
    #chat-header { 
        padding: 5px; border-bottom: 1px solid var(--border-color); 
        background: var(--hazard-yellow); color: #000; 
        font-size: 0.9em; font-weight: bold; text-transform: uppercase;
    }
    #chat-messages { flex-grow: 1; overflow-y: auto; padding: 8px; font-size: 0.85em; display: flex; flex-direction: column; gap: 4px; scrollbar-width: thin; scrollbar-color: var(--hazard-yellow) #000; }
    .msg { word-wrap: break-word; border-left: 2px solid #333; padding-left: 5px; } 
    .msg-user { color: var(--hazard-yellow); font-weight: bold; } 
    .msg-text { color: #ddd; } 
    .msg-system { color: var(--error-color); font-style: italic; }
    #chat-form { display: flex; border-top: 1px solid var(--border-color); }
    #chat-input { flex-grow: 1; background: #111; border: none; padding: 8px; color: var(--hazard-yellow); font-family: inherit; outline: none; }
    #chat-btn { background: #222; border: none; border-left: 1px solid var(--border-color); color: var(--hazard-yellow); padding: 0 10px; cursor: pointer; font-family: inherit; }
    #chat-btn:hover { background: var(--hazard-yellow); color: #000; }
    #chat-btn:disabled { cursor: not-allowed; opacity: 0.5; }

    /* --- LEADERBOARD --- */
    #leaderboard-panel { 
        position: absolute; top: 80px; left: 20px; width: 200px; 
        background: rgba(0, 0, 0, 0.8); border: 1px solid var(--hazard-yellow); 
        border-radius: 0; padding: 10px; z-index: 50; pointer-events: none; 
    }
    #leaderboard-panel h3 { font-size: 1em; color: var(--hazard-yellow); margin-bottom: 5px; text-align: center; border-bottom: 1px dashed #333; padding-bottom: 5px; background: transparent; box-shadow: none; }
    #leaderboard-list { list-style: none; padding: 0; margin: 0; font-size: 0.85em; }
    #leaderboard-list li { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #222; }
    .lb-name { color: #fff; font-weight: bold; } .lb-score { color: var(--viral-green); }

    @keyframes flashGreen { 0% { background-color: var(--viral-green); } 100% { background-color: rgba(20, 20, 20, 0.8); } } 
    @keyframes shakeRed { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); border-color: var(--error-color); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    .blink-cursor::after { content: '‚ñà'; animation: blink 1s infinite; margin-left: 5px; color: var(--hazard-yellow); }
    @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }

    /* --- ICONES UI GAUCHE (Settings & Stats) --- */
    .ui-icon-btn {
      position: absolute; left: 15px;
      font-size: 2em; cursor: pointer; z-index: 100;
      color: var(--hazard-yellow); transition: transform 0.3s, color 0.3s;
      filter: drop-shadow(0 0 5px #000); width: 40px; height: 40px; text-align: center;
    }
    .ui-icon-btn:hover { transform: scale(1.2); color: #fff; }
    
    #settings-btn { top: 15px; }
    #settings-btn:hover { transform: rotate(90deg); }
    
    #stats-btn { top: 65px; font-size: 1.8em; }

    /* --- STYLES PARAM√àTRES & STATS --- */
    .setting-row, .stat-row {
      display: flex; justify-content: space-between; align-items: center;
      font-size: 1.1em; color: #aaffaa; padding: 5px 0; border-bottom: 1px solid #222;
    }
    .stat-row span:last-child { font-weight: bold; color: var(--viral-green); }
    .stat-group { margin-bottom: 15px; }
    .stat-group h3 { font-size: 0.9em; color: #888; text-transform: uppercase; border-bottom: 1px dashed #444; margin-bottom: 5px; }

    .setting-toggle {
      background: transparent; border: 1px solid var(--viral-green);
      color: var(--viral-green); padding: 5px 15px; cursor: pointer;
      font-family: inherit; font-weight: bold; min-width: 60px;
    }
    .setting-toggle.off { border-color: #555; color: #555; }
    .setting-toggle:hover { background: var(--viral-green); color: #000; box-shadow: 0 0 10px var(--viral-green); }
    .setting-toggle.off:hover { background: #555; color: #fff; box-shadow: none; }
    .setting-toggle.danger { border-color: var(--error-color); color: var(--error-color); }
    .setting-toggle.danger:hover { background: var(--error-color); color: #fff; box-shadow: 0 0 15px var(--error-color); }

  </style>
</head>
<body>
  <div id="global-crt"></div>

  <div id="login-overlay">
    <div id="login-box"><h2>IDENTIFICATION REQUISE</h2><p style="color: #aaa; margin-bottom: 20px;">Acc√®s au Laboratoire</p><form id="login-form"><input type="text" id="login-input" placeholder="Votre Nom de Code" maxlength="15" autocomplete="off"><br><button type="submit" id="login-btn">ACC√âDER</button></form></div>
  </div>

  <div id="context-overlay">
    <div id="context-box">
      <h2 class="blink-cursor">‚ò£_ TRANSMISSION S√âCURIS√âE</h2>
      <div id="context-text"></div>
      <button id="start-mission-btn">ACCEPTER LE PROTOCOLE</button>
    </div>
  </div>
  
  <canvas id="bio-canvas"></canvas>

  <div id="passive-particle-container"></div>
  <div class="container">
    <div id="game-area">
      <div id="settings-btn" class="ui-icon-btn">‚öôÔ∏è</div>
      <div id="stats-btn" class="ui-icon-btn">üìä</div>
      
      <h1>‚ò£ Projet : Gen√®se ‚ò£</h1><div id="player-count">SCIENTIFIQUES : 0</div>
      <div class="score-panel"><div id="scoreDisplay">0</div><p class="score-label">Cellules Infect√©es</p><div id="cps-display">+0 CI/s</div></div>
      <div id="leaderboard-panel"><h3>Top Contagion</h3><ul id="leaderboard-list"></ul></div>
      <div id="cell-button"></div><div id="click-info">PUISSANCE: +1</div> 
      <div id="particle-container"></div>
      <div id="chat-container"><div id="chat-header">ID: <span id="current-username-display">Anonyme</span></div><div id="chat-messages"><div class="msg"><span class="msg-user">SYST√àME:</span> <span class="msg-text">Connexion √©tablie.</span></div></div><form id="chat-form"><input type="text" id="chat-input" placeholder="50 clics requis..." autocomplete="off"><button type="submit" id="chat-btn">></button></form></div>
      
      <div id="signature">By Swapeur</div>
      
    </div>
    <div id="store-area">
      <div id="prestige-area"><h3>RECHERCHE AVANC√âE</h3><p>+<span id="p-gain">0</span> PR au reset</p><p>Total: <span id="p-total">0</span> PR</p><button class="prestige-btn secondary" id="btn-meta">M√©ta-Recherche (üß†)</button><button class="prestige-btn" id="btn-reset">MUTATION GLOBALE</button></div>
      <div id="boost-area"><h3>RECHERCHE</h3><div id="boost-container"></div></div>
      <h2>AM√âLIORATIONS</h2>
      
      <div class="store-item revealed" id="b-mutation"><div class="item-info"><h3>Mutation Mineure</h3><p class="item-desc">Tiens ? Un troisi√®me bras a pouss√©.</p><p class="item-gain">+0.1 CI/s</p></div><div class="item-stats"><span class="item-cost">15</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-oiseau"><div class="item-info"><h3>Vecteur Oiseau</h3><p class="item-desc">Roucoule, tousse, propage, r√©p√®te.</p><p class="item-gain">+1 CI/s</p></div><div class="item-stats"><span class="item-cost">100</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-eau"><div class="item-info"><h3>Contamination Eau</h3><p class="item-desc">Enrichie en min√©raux et en pathog√®nes.</p><p class="item-gain">+8 CI/s</p></div><div class="item-stats"><span class="item-cost">1100</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-aerosol"><div class="item-info"><h3>Transmission A√©rosol</h3><p class="item-desc">L'amour est dans l'air. La mort aussi.</p><p class="item-gain">+47 CI/s</p></div><div class="item-stats"><span class="item-cost">12000</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-aeroport"><div class="item-info"><h3>A√©roport International</h3><p class="item-desc">Tour du monde en 80 fi√®vres.</p><p class="item-gain">+260 CI/s</p></div><div class="item-stats"><span class="item-cost">130000</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-ferme"><div class="item-info"><h3>Fermes Virales</h3><p class="item-desc">√âlev√© en plein air, mort en plein air.</p><p class="item-gain">+2k CI/s</p></div><div class="item-stats"><span class="item-cost">500000</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-centre"><div class="item-info"><h3>Centres de Contagion</h3><p class="item-desc">La promiscuit√©, c'est l'avenir de l'esp√®ce.</p><p class="item-gain">+15k CI/s</p></div><div class="item-stats"><span class="item-cost">5M</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-propagande"><div class="item-info"><h3>Propagande Virale</h3><p class="item-desc">"Ne paniquez pas, c'est juste une allergie."</p><p class="item-gain">+100k CI/s</p></div><div class="item-stats"><span class="item-cost">50M</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-satellite"><div class="item-info"><h3>Satellite de Dispersion</h3><p class="item-desc">Pr√©visions m√©t√©o : averses de spores.</p><p class="item-gain">+1.2M CI/s</p></div><div class="item-stats"><span class="item-cost">600M</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-clonage"><div class="item-info"><h3>Clonage Humain</h3><p class="item-desc">On ne manque plus de volontaires pour les tests.</p><p class="item-gain">+20M CI/s</p></div><div class="item-stats"><span class="item-cost">7.5Md</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-terraformation"><div class="item-info"><h3>Terraformation Virale</h3><p class="item-desc">Une plan√®te verte... de pus et de n√©crose.</p><p class="item-gain">+350M CI/s</p></div><div class="item-stats"><span class="item-cost">95Md</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-singularite"><div class="item-info"><h3>Singularit√© Biologique</h3><p class="item-desc">Toute la biomasse fusionn√©e en une seule entit√©.</p><p class="item-gain">+8Md CI/s</p></div><div class="item-stats"><span class="item-cost">1.5Tn</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-echo"><div class="item-info"><h3>√âchos Dimensionnels</h3><p class="item-desc">La membrane de la r√©alit√© commence √† tousser.</p><p class="item-gain">+50Md CI/s</p></div><div class="item-stats"><span class="item-cost">10Tn</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-nano"><div class="item-info"><h3>Nanobots</h3><p class="item-desc">Des virus synth√©tiques qui n'arr√™tent jamais.</p><p class="item-gain">+1.5Tn CI/s</p></div><div class="item-stats"><span class="item-cost">250Tn</span><span class="item-count">0</span></div></div>
      
      <div class="store-item" id="b-nova"><div class="item-info"><h3>Supernova Virale</h3><p class="item-desc">L'univers entier est notre bo√Æte de Petri.</p><p class="item-gain">+100Qa CI/s</p></div><div class="item-stats"><span class="item-cost">8Qa</span><span class="item-count">0</span></div></div>

    </div>
  </div>
  <div id="tooltip"></div>
  
  <div id="modal-backdrop" class="modal-backdrop"><div id="modal" class="modal-content"><div class="modal-header"><h2>M√©ta-Recherche</h2><p>Am√©liorations permanentes</p></div><div id="modal-body" class="modal-body"></div><button class="close-btn" onclick="document.getElementById('modal-backdrop').style.display='none'">Fermer</button></div></div>

  <div id="settings-modal-backdrop" class="modal-backdrop">
    <div id="settings-modal" class="modal-content" style="width: 400px;">
      <div class="modal-header">
        <h2>CONFIGURATION SYST√àME</h2>
      </div>
      <div class="modal-body">
        <div class="setting-row">
          <span>AUDIO (SFX)</span>
          <button id="toggle-audio" class="setting-toggle">ON</button>
        </div>
        <div class="setting-row">
          <span>FILTRE CRT (Scanlines)</span>
          <button id="toggle-crt" class="setting-toggle">ON</button>
        </div>
        <div class="setting-row">
          <span>PARTICULES (Performance)</span>
          <button id="toggle-particles" class="setting-toggle">ON</button>
        </div>
        <hr style="border: 0; border-top: 1px dashed #333; margin: 10px 0;">
        <div class="setting-row">
          <span>ID SESSION</span>
          <button id="btn-logout" class="setting-toggle danger">D√âCONNEXION</button>
        </div>
        <button id="close-settings" class="close-btn">APPLIQUER & FERMER</button>
      </div>
    </div>
  </div>

  <div id="stats-modal-backdrop" class="modal-backdrop">
    <div id="stats-modal" class="modal-content">
      <div class="modal-header">
        <h2>DONN√âES √âPID√âMIOLOGIQUES</h2>
        <p>Rapport d'analyse global</p>
      </div>
      <div class="modal-body" id="stats-body">
        <div class="stat-group">
          <h3>Statistiques Globales (Monde)</h3>
          <div class="stat-row"><span>Total Infect√© (Depuis toujours)</span> <span id="stat-total-ever">0</span></div>
          <div class="stat-row"><span>Total Clicks (Tous joueurs)</span> <span id="stat-total-clicks">0</span></div>
          <div class="stat-row"><span>Boosts D√©couverts</span> <span id="stat-boosts-unlocked">0</span></div>
          <div class="stat-row"><span>Points de Prestige (PR)</span> <span id="stat-prestige">0</span></div>
        </div>
        
        <div class="stat-group">
          <h3>Session Locale (Vous)</h3>
          <div class="stat-row"><span>Stock Actuel</span> <span id="stat-current-score">0</span></div>
          <div class="stat-row"><span>Production Actuelle</span> <span id="stat-current-cps">0 CI/s</span></div>
          <div class="stat-row"><span>Clics cette session</span> <span id="stat-local-clicks">0</span></div>
          <div class="stat-row"><span>Temps de session</span> <span id="stat-session-time">00:00</span></div>
        </div>
        <button class="close-btn" onclick="document.getElementById('stats-modal-backdrop').style.display='none'">Fermer le Rapport</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    let deviceId = localStorage.getItem('viral_device_id');
    if (!deviceId) {
      deviceId = 'id_' + Math.random().toString(36).substr(2, 9) + Date.now();
      localStorage.setItem('viral_device_id', deviceId);
    }

    const socket = io({ auth: { token: deviceId } });

    // --- VARIABLES SESSION ---
    let mySessionClicks = 0;
    const sessionStartTime = Date.now();

    // --- GESTION DES PARAM√àTRES ---
    const defaultSettings = { audio: true, crt: true, particles: true };
    let userSettings = JSON.parse(localStorage.getItem('viral_settings')) || defaultSettings;

    function saveSettings() {
      localStorage.setItem('viral_settings', JSON.stringify(userSettings));
      applySettings();
    }

    function applySettings() {
      const crtEl = document.getElementById('global-crt');
      if (crtEl) crtEl.style.display = userSettings.crt ? 'block' : 'none';
      
      updateBtnState('toggle-audio', userSettings.audio);
      updateBtnState('toggle-crt', userSettings.crt);
      updateBtnState('toggle-particles', userSettings.particles);
    }

    function updateBtnState(id, state) {
      const btn = document.getElementById(id);
      if(!btn) return;
      btn.innerText = state ? 'ON' : 'OFF';
      btn.className = state ? 'setting-toggle' : 'setting-toggle off';
    }
    
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const Sound = {
      click: () => { 
        if (!userSettings.audio) return;
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; 
        osc.frequency.setValueAtTime(400, audioCtx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15); 
        gain.gain.setValueAtTime(0.3, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.15); 
      },
      buy: () => { 
        if (!userSettings.audio) return;
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'triangle'; 
        osc.frequency.setValueAtTime(200, audioCtx.currentTime); 
        osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); 
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime); 
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
      },
      chat: () => { 
        if (!userSettings.audio) return;
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; 
        osc.frequency.setValueAtTime(800, audioCtx.currentTime); 
        gain.gain.setValueAtTime(0.05, audioCtx.currentTime); 
        gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.1); 
      },
      bonus: () => { 
        if (!userSettings.audio) return;
        if(audioCtx.state === 'suspended') audioCtx.resume(); 
        const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
        osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; 
        osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
        osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.3); 
        gain.gain.setValueAtTime(0.2, audioCtx.currentTime); 
        gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3); 
        osc.start(); osc.stop(audioCtx.currentTime + 0.3); 
      }
    };

    let lastState = null; let lastUpdate = Date.now(); let currentScore = 0; let currentClickValue = 1;
    const scoreEl = document.getElementById('scoreDisplay'); const cellBtn = document.getElementById('cell-button'); const tooltip = document.getElementById('tooltip'); const partCont = document.getElementById('particle-container'); const passPartCont = document.getElementById('passive-particle-container'); const storeEl = document.getElementById('store-area'); const leaderboardList = document.getElementById('leaderboard-list');
    
    function formatNumber(num) { 
      if (num < 1000) return parseFloat(num.toFixed(1));
      if (num < 1000000) return parseFloat((num / 1000).toFixed(2)) + 'k'; 
      if (num < 1000000000) return parseFloat((num / 1000000).toFixed(2)) + 'M'; 
      if (num < 1000000000000) return parseFloat((num / 1000000000).toFixed(2)) + 'Md'; 
      if (num < 1000000000000000) return parseFloat((num / 1000000000000).toFixed(2)) + 'Tn'; 
      if (num < 1000000000000000000) return parseFloat((num / 1000000000000000).toFixed(2)) + 'Qa'; 
      return parseFloat((num / 1000000000000000000).toFixed(2)) + 'Qi'; 
    }

    function formatTime(ms) {
      const seconds = Math.floor((ms / 1000) % 60);
      const minutes = Math.floor((ms / (1000 * 60)) % 60);
      const hours = Math.floor((ms / (1000 * 60 * 60)));
      return `${hours}h ${minutes}m ${seconds}s`;
    }

    const loginOverlay = document.getElementById('login-overlay'); const loginForm = document.getElementById('login-form'); const loginInput = document.getElementById('login-input'); const currentUsernameDisplay = document.getElementById('current-username-display');
    
    const contextOverlay = document.getElementById('context-overlay');
    const contextTextDiv = document.getElementById('context-text');
    const startMissionBtn = document.getElementById('start-mission-btn');

    const BRIEFING_TEXT = 
`IDENTIFICATION CONFIRM√âE.

Bienvenue dans le Projet Gen√®se, Scientifique.

Votre mission est simple : cultiver la souche primitive. 

Nous ignorons encore ses capacit√©s, mais les premi√®res simulations indiquent un potentiel de croissance exponentiel.


Ne vous posez pas de questions sur l'origine des √©chantillons.

Ne vous inqui√©tez pas des effets secondaires.

Concentrez-vous sur la production.


Le monde est pr√™t pour la prochaine √©tape de l'√©volution.

√Ä vous de jouer.


TERMINE.`;

    if(localStorage.getItem('viral_username')) loginInput.value = localStorage.getItem('viral_username');

    loginForm.onsubmit = (e) => { 
        e.preventDefault(); 
        const name = loginInput.value.trim(); 
        if(name.length > 0) { 
            if(userSettings.audio && audioCtx.state === 'suspended') audioCtx.resume(); 
            socket.emit('set_username', name); 
            currentUsernameDisplay.innerText = name; 
            localStorage.setItem('viral_username', name); 
            
            loginOverlay.style.display = 'none'; 
            launchContextSequence(); 
        } else { 
            loginInput.style.borderColor = "var(--error-color)"; 
            setTimeout(() => loginInput.style.borderColor = "var(--hazard-yellow)", 300); 
        } 
    };
    
    function launchContextSequence() {
        contextOverlay.style.display = 'flex';
        let i = 0;
        const speed = 30; 

        function typeWriter() {
            if (i < BRIEFING_TEXT.length) {
                contextTextDiv.textContent += BRIEFING_TEXT.charAt(i);
                i++;
                setTimeout(typeWriter, speed);
            } else {
                startMissionBtn.style.display = 'block';
                startMissionBtn.classList.add('revealed');
            }
        }
        typeWriter();
    }

    startMissionBtn.onclick = () => {
        Sound.buy(); 
        contextOverlay.style.opacity = '0';
        contextOverlay.style.transition = 'opacity 1s ease';
        setTimeout(() => {
            contextOverlay.style.display = 'none';
        }, 1000);
    };
    
    const chatForm = document.getElementById('chat-form'); 
    const chatInput = document.getElementById('chat-input'); 
    const chatMsg = document.getElementById('chat-messages');
    const chatBtn = document.getElementById('chat-btn');
    
    let lastChatTimestamp = 0;
    let isPolling = false; 

    chatForm.onsubmit = (e) => { 
      e.preventDefault(); 
      const txt = chatInput.value.trim(); 
      const username = currentUsernameDisplay.innerText;

      if(txt && !chatBtn.disabled) { 
        chatBtn.disabled = true;
        chatBtn.style.opacity = '0.5';
        chatBtn.style.cursor = 'not-allowed';

        fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user: username, text: txt })
        })
        .then(res => res.json())
        .then(data => {
          if(data.error) {
             addMessageToChat('Syst√®me', `‚õî ${data.error}`, 'msg-system');
             setTimeout(() => { chatBtn.disabled = false; chatBtn.style.opacity = '1'; chatBtn.style.cursor = 'pointer'; }, 500);
          } else {
            chatInput.value = ''; 
            Sound.chat(); 
            pollChat(); 
            setTimeout(() => { chatBtn.disabled = false; chatBtn.style.opacity = '1'; chatBtn.style.cursor = 'pointer'; chatInput.focus(); }, 3000);
          }
        })
        .catch(err => {
            console.error("Erreur chat", err);
            chatBtn.disabled = false; chatBtn.style.opacity = '1'; chatBtn.style.cursor = 'pointer';
        });
      } 
    };

    function pollChat() {
      if (isPolling) return; 
      isPolling = true;

      fetch(`/api/chat?since=${lastChatTimestamp}`)
        .then(res => res.json())
        .then(messages => {
          if (messages.length > 0) {
            messages.forEach(msg => {
              addMessageToChat(msg.user, msg.text, msg.user === 'Syst√®me' ? 'msg-system' : null, msg.id);
              if(msg.timestamp > lastChatTimestamp) lastChatTimestamp = msg.timestamp;
            });
            const myName = currentUsernameDisplay.innerText;
            const lastMsg = messages[messages.length-1];
            if(lastMsg.user !== myName && lastMsg.user !== 'Syst√®me') { Sound.chat(); }
          }
        })
        .catch(err => console.error("Polling chat error", err))
        .finally(() => { isPolling = false; });
    }
    
    function addMessageToChat(user, text, specificClass, msgId) {
      if (msgId && document.getElementById('msg-' + msgId)) return; 
      const div = document.createElement('div'); 
      div.className = 'msg'; 
      if (msgId) div.id = 'msg-' + msgId;
      let userClass = specificClass || 'msg-user';
      div.innerHTML = `<span class="${userClass}">${user}:</span> <span class="msg-text">${text}</span>`; 
      chatMsg.appendChild(div); 
      
      const isAtBottom = chatMsg.scrollHeight - chatMsg.scrollTop <= chatMsg.clientHeight + 100;
      if(isAtBottom || user === currentUsernameDisplay.innerText) {
           chatMsg.scrollTop = chatMsg.scrollHeight;
      }
    }
    setInterval(pollChat, 2000);
    
    socket.on('spawn_bonus', (data) => {
      const bonus = document.createElement('div');
      bonus.className = 'bonus-mutation';
      bonus.innerText = '‚ò£Ô∏è'; 
      const x = Math.random() * (window.innerWidth - 100) + 50;
      const y = Math.random() * (window.innerHeight - 100) + 50;
      bonus.style.left = x + 'px';
      bonus.style.top = y + 'px';
      bonus.id = data.id; 
      bonus.onclick = (e) => {
        if(!e.isTrusted) return; 
        socket.emit('click_bonus', data.id);
        Sound.bonus();
        bonus.remove(); 
        spawnFloatingText(e, "MUTATION !");
      };
      document.body.appendChild(bonus);
      setTimeout(() => { if(bonus.parentNode) bonus.remove(); }, 10000);
    });

    const builds = { 
        'mutation_mineure': 'b-mutation', 'vecteur_oiseau': 'b-oiseau', 'contamination_eau': 'b-eau', 
        'transmission_aerosol': 'b-aerosol', 'aeroport_international': 'b-aeroport', 'fermes_virales': 'b-ferme', 
        'centres_contagion': 'b-centre', 'propagande_virale': 'b-propagande', 'satellite_dispersion': 'b-satellite', 
        'clonage_humain': 'b-clonage', 'terraformation_virale': 'b-terraformation', 'singularite_biologique': 'b-singularite',
        'echos_dimensionnels': 'b-echo', 'nanobots_autoreplicants': 'b-nano', 'supernova_virale': 'b-nova'
    };

    function showTip(e, title, cost, desc, gain, total) { let h = `<h4>${title}</h4><div class="cost">Co√ªt: ${formatNumber(cost)} CI</div><div class="desc">${desc}</div>`; if(gain) h += `<div class="stats">Gain: ${formatNumber(gain)} CI/s<br>Total: ${formatNumber(total)} CI/s</div>`; tooltip.innerHTML = h; tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px'; tooltip.style.display = 'block'; }
    function hideTip() { tooltip.style.display = 'none'; } function moveTip(e) { tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px'; }
    
    function spawnBuyExplosion(x, y) {
      if (!userSettings.particles) return;
      const colors = ['#ffd700', '#fff', '#aaffaa']; 
      for(let i=0; i<12; i++) {
        const p = document.createElement('div');
        p.className = 'buy-particle';
        p.style.left = x + 'px';
        p.style.top = y + 'px';
        p.style.background = colors[Math.floor(Math.random()*colors.length)];
        
        const angle = Math.random() * Math.PI * 2;
        const velocity = Math.random() * 60 + 30;
        const tx = Math.cos(angle) * velocity;
        const ty = Math.sin(angle) * velocity;
        
        p.style.setProperty('--tx', tx + 'px');
        p.style.setProperty('--ty', ty + 'px');
        
        document.body.appendChild(p);
        setTimeout(() => p.remove(), 800);
      }
    }

    for(let k in builds) { 
        const el = document.getElementById(builds[k]); 
        el.onclick = (e) => { 
            if(!lastState) return; 
            const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0); 
            if(currentScore >= cost) { 
                socket.emit('buy_upgrade', k); 
                el.classList.add('purchased-anim'); 
                setTimeout(()=>el.classList.remove('purchased-anim'),300); 
                Sound.buy(); 
                
                let ex = e.clientX;
                let ey = e.clientY;
                if(!ex || !ey) {
                    const r = el.getBoundingClientRect();
                    ex = r.left + r.width/2;
                    ey = r.top + r.height/2;
                }
                spawnBuyExplosion(ex, ey);
            } else { 
                el.classList.add('error-anim'); 
                setTimeout(()=>el.classList.remove('error-anim'),300); 
            } 
        }; 
        el.onmouseenter = (e) => { if(!lastState) return; let costKey = 'cost_' + k.split('_')[0].replace('vecteur','oiseau').replace('contamination','eau').replace('transmission','aerosol').replace('aeroport','aeroport').replace('fermes','ferme').replace('centres','centre').replace('propagande','propagande'); if(k.startsWith('satellite')) costKey = 'cost_satellite'; if(k.startsWith('clonage')) costKey = 'cost_clonage'; if(k.startsWith('terraformation')) costKey = 'cost_terraformation'; if(k.startsWith('singularite')) costKey = 'cost_singularite'; if(k.startsWith('echos')) costKey = 'cost_echo'; if(k.startsWith('nanobots')) costKey = 'cost_nano'; if(k.startsWith('supernova')) costKey = 'cost_nova'; const gainKey = costKey.replace('cost','gain'); const name = el.querySelector('h3').innerText; const desc = el.querySelector('.item-desc').innerText; const cost = parseFloat(el.querySelector('.item-cost').dataset.raw); const gain = parseFloat(el.querySelector('.item-gain').dataset.raw); let countKey = k; if(k=='mutation_mineure') countKey='mutations_mineures'; if(k=='vecteur_oiseau') countKey='vecteurs_oiseaux'; const count = lastState[countKey] || 0; showTip(e, name, cost, desc, gain, gain*count); }; el.onmousemove = moveTip; el.onmouseleave = hideTip; 
    }
    
    cellBtn.onclick = (e) => { 
      if (!e.isTrusted) return; 
      socket.emit('click_cell'); 
      
      // Session stats
      mySessionClicks++;

      const ripple = document.createElement('div');
      ripple.className = 'ripple';
      const rect = cellBtn.getBoundingClientRect();
      const size = Math.max(rect.width, rect.height); 
      ripple.style.width = ripple.style.height = size + 'px';
      
      let x = e.clientX - rect.left - size/2;
      let y = e.clientY - rect.top - size/2;
      if(e.clientX === 0 && e.clientY === 0) { x = -size/2 + rect.width/2; y = -size/2 + rect.height/2; }

      ripple.style.left = x + 'px';
      ripple.style.top = y + 'px';
      cellBtn.appendChild(ripple);
      setTimeout(() => ripple.remove(), 600);
      
      cellBtn.classList.add('clicked'); 
      setTimeout(()=>cellBtn.classList.remove('clicked'),100); 
      spawnParticle(cellBtn, 5); 
      spawnFloatingText(e, currentClickValue); 
      Sound.click(); 
    };

    function spawnFloatingText(e, amount) { 
      const el = document.createElement('div'); 
      el.className = 'float-text'; 
      el.innerText = (typeof amount === 'string' ? '' : '+') + (typeof amount === 'number' ? formatNumber(amount) : amount); 
      let x = e.clientX; let y = e.clientY; 
      if(!x && !y) { const rect = cellBtn.getBoundingClientRect(); x = rect.left + rect.width/2; y = rect.top + rect.height/2; } 
      x += (Math.random() - 0.5) * 30; 
      el.style.left = x + 'px'; el.style.top = y + 'px'; 
      document.body.appendChild(el); 
      setTimeout(() => el.remove(), 800); 
    }

    document.getElementById('btn-reset').onclick = () => { if(confirm('Prestige ? Reset complet vs PR.')) socket.emit('do_prestige'); }; document.getElementById('btn-meta').onclick = () => { document.getElementById('modal-backdrop').style.display = 'flex'; renderPrestigeShop(); }; document.getElementById('modal-backdrop').onclick = (e) => { if(e.target.id === 'modal-backdrop') e.target.style.display = 'none'; };

    // LOGIQUE UI (Param√®tres & Stats)
    const settingsBtn = document.getElementById('settings-btn');
    const settingsBackdrop = document.getElementById('settings-modal-backdrop');
    const closeSettingsBtn = document.getElementById('close-settings');

    settingsBtn.onclick = () => {
      settingsBackdrop.style.display = 'flex';
      applySettings();
    };
    closeSettingsBtn.onclick = () => { settingsBackdrop.style.display = 'none'; };

    document.getElementById('toggle-audio').onclick = () => { userSettings.audio = !userSettings.audio; saveSettings(); };
    document.getElementById('toggle-crt').onclick = () => { userSettings.crt = !userSettings.crt; saveSettings(); };
    document.getElementById('toggle-particles').onclick = () => { userSettings.particles = !userSettings.particles; saveSettings(); };
    document.getElementById('btn-logout').onclick = () => {
      if(confirm("ATTENTION : Cela effacera votre identit√© locale. Si vous n'avez pas not√© votre ID, la progression sera inaccessible. Continuer ?")) {
        localStorage.removeItem('viral_device_id');
        localStorage.removeItem('viral_username');
        location.reload();
      }
    };
    
    // LOGIQUE STATS
    const statsBtn = document.getElementById('stats-btn');
    const statsBackdrop = document.getElementById('stats-modal-backdrop');
    
    statsBtn.onclick = () => {
        statsBackdrop.style.display = 'flex';
        updateStats();
    };
    
    function updateStats() {
        if (!lastState) return;
        const s = lastState;
        document.getElementById('stat-total-ever').innerText = formatNumber(s.totalCellsEver || 0);
        document.getElementById('stat-total-clicks').innerText = formatNumber(s.totalClicks || 0);
        document.getElementById('stat-boosts-unlocked').innerText = (s.purchasedBoosts ? s.purchasedBoosts.length : 0);
        document.getElementById('stat-prestige').innerText = formatNumber(s.prestigePoints || 0);
        
        document.getElementById('stat-current-score').innerText = formatNumber(currentScore);
        document.getElementById('stat-current-cps').innerText = formatNumber(s.cellsPerSecond || 0) + " CI/s";
        document.getElementById('stat-local-clicks').innerText = mySessionClicks;
        document.getElementById('stat-session-time').innerText = formatTime(Date.now() - sessionStartTime);
        
        if(statsBackdrop.style.display === 'flex') {
            requestAnimationFrame(updateStats);
        }
    }

    // Initialisation au chargement
    applySettings();

    socket.on('tick_update', (d) => { 
      if(!lastState) return; 
      lastState.totalInfectedCells = d.score; 
      lastState.cellsPerSecond = d.cps; 
      currentClickValue = d.clickValue; 
      lastUpdate = Date.now(); 
      
      const hue_cell = Math.min(d.clickHeat*0.8, 120); 

      document.getElementById('player-count').innerText = 'SCIENTIFIQUES : ' + d.players; 
      document.getElementById('cps-display').innerText = '+' + formatNumber(d.cps) + ' CI/s'; 
      document.getElementById('click-info').innerText = 'PUISSANCE: +' + formatNumber(d.clickValue); 
      
      if(d.leaderboard) { 
        leaderboardList.innerHTML = ''; 
        d.leaderboard.forEach(p => { 
          const li = document.createElement('li'); 
          li.innerHTML = `<span class="lb-name">${p.name}</span> <div style="text-align:right"><span class="lb-score">${formatNumber(p.contribution)}</span><small style="color:#666; font-size:0.8em; margin-left:5px;">(${p.clicks} üñ±Ô∏è)</small></div>`; 
          leaderboardList.appendChild(li); 
        }); 
      } 
    });

    socket.on('full_update', (d) => { lastState = d.gameState; lastUpdate = Date.now(); prestigeUpgradesList = d.prestigeUpgrades; const s = lastState; const update = (key, cKey, gKey, cntKey) => { const el = document.getElementById(builds[key]); if(el) { const cost = s[cKey]; const gain = s[gKey]; const count = s[cntKey]; el.querySelector('.item-cost').innerText = formatNumber(cost); el.querySelector('.item-cost').dataset.raw = cost; el.querySelector('.item-count').innerText = count; el.querySelector('.item-gain').innerText = `+${formatNumber(gain)} CI/s`; el.querySelector('.item-gain').dataset.raw = gain; } }; 
    update('mutation_mineure', 'cost_mutation', 'gain_mutation', 'mutations_mineures'); update('vecteur_oiseau', 'cost_oiseau', 'gain_oiseau', 'vecteurs_oiseaux'); update('contamination_eau', 'cost_eau', 'gain_eau', 'contamination_eau'); update('transmission_aerosol', 'cost_aerosol', 'gain_aerosol', 'transmission_aerosol'); update('aeroport_international', 'cost_aeroport', 'gain_aeroport', 'aeroport_international'); update('fermes_virales', 'cost_ferme', 'gain_ferme', 'fermes_virales'); update('centres_contagion', 'cost_centre', 'gain_centre', 'centres_contagion'); update('propagande_virale', 'cost_propagande', 'gain_propagande', 'propagande_virale'); update('satellite_dispersion', 'cost_satellite', 'gain_satellite', 'satellite_dispersion'); update('clonage_humain', 'cost_clonage', 'gain_clonage', 'clonage_humain'); update('terraformation_virale', 'cost_terraformation', 'gain_terraformation', 'terraformation_virale'); update('singularite_biologique', 'cost_singularite', 'gain_singularite', 'singularite_biologique'); 
    update('echos_dimensionnels', 'cost_echo', 'gain_echo', 'echos_dimensionnels'); update('nanobots_autoreplicants', 'cost_nano', 'gain_nano', 'nanobots_autoreplicants'); update('supernova_virale', 'cost_nova', 'gain_nova', 'supernova_virale');

    const boostCont = document.getElementById('boost-container'); boostCont.innerHTML = ''; for(const b of d.availableBoosts) { const el = document.createElement('div'); el.className = 'boost-item'; let ico = '‚ùì'; if(b.id.includes('seringue') || b.id.includes('gants')) ico='üß§'; else if(b.id.includes('doigts')) ico='ü¶æ'; else if(b.id.includes('rage')) ico='ü©∏'; else if(b.id.includes('osmose')) ico='‚ö°'; else if(b.id.includes('neurones')) ico='üß†'; else if(b.id.includes('clics')) ico='üñ±Ô∏è'; else if(b.id.includes('mutation')) ico='üß¨'; else if(b.id.includes('plumes')||b.id.includes('oiseau')) ico='ü™∂'; else if(b.id.includes('filtres')||b.id.includes('eau')) ico='üíß'; else if(b.id.includes('spores')||b.id.includes('aerosol')) ico='üí®'; else if(b.id.includes('partenariats')||b.id.includes('aeroport')) ico='‚úàÔ∏è'; else if(b.id.includes('nutriments')||b.id.includes('ferme')) ico='üåø'; else if(b.id.includes('gentrification')||b.id.includes('centre')) ico='üèôÔ∏è'; else if(b.id.includes('fake')||b.id.includes('propagande')) ico='üì∞'; else if(b.id.includes('sat')) ico='üì°'; else if(b.id.includes('clone')) ico='üëØ'; else if(b.id.includes('terra')) ico='üåç'; else if(b.id.includes('singu')) ico='üåå'; else if(b.id.includes('matrice')) ico='üí†'; else if(b.id.includes('synergie')) ico='üîó'; else if(b.id.includes('contamination')) ico='‚ò£Ô∏è'; 
    else if(b.id.includes('echo')) ico='üåå'; else if(b.id.includes('nano')) ico='ü§ñ'; else if(b.id.includes('nova')) ico='üí•'; else if(b.id.includes('omnipotence')) ico='üëë'; else if(b.id.includes('doigt')) ico='üëÜ';

    el.innerText = ico; el.onclick = () => { let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; if(currentScore >= cost) { socket.emit('buy_boost', b.id); el.remove(); Sound.buy(); } else { el.classList.add('error-anim'); setTimeout(()=>el.classList.remove('error-anim'),300); } }; el.onmouseenter = (e) => { let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; showTip(e, b.name, cost, b.description); }; el.onmousemove = moveTip; el.onmouseleave = hideTip; let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; el.dataset.cost = cost; boostCont.appendChild(el); } const pInfo = d.prestigeInfo; const pArea = document.getElementById('prestige-area'); if(pInfo.canPrestige || s.prestigePoints > 0) { pArea.style.display = 'block'; document.getElementById('p-gain').innerText = formatNumber(pInfo.pointsOnReset); document.getElementById('p-total').innerText = formatNumber(s.prestigePoints); } else { pArea.style.display = 'none'; } renderPrestigeShop(); });
    function renderPrestigeShop() { if(!lastState) return; const body = document.getElementById('modal-body'); body.innerHTML = ''; for(const id in prestigeUpgradesList) { const u = prestigeUpgradesList[id]; const row = document.createElement('div'); row.className = 'p-upgrade'; row.innerHTML = `<div><h4>${u.name}</h4><div class="description">${u.description}</div></div><div class="cost">${u.cost} PR</div>`; const isBought = lastState.purchasedPrestigeUpgrades.includes(id); const canBuy = lastState.prestigePoints >= u.cost; if(isBought) row.classList.add('purchased'); else if(!canBuy) row.classList.add('disabled'); row.onclick = () => { if(!isBought && canBuy) { socket.emit('buy_prestige_upgrade', id); row.classList.add('purchased'); Sound.buy(); } else if (!isBought) { row.classList.add('error-anim'); setTimeout(()=>row.classList.remove('error-anim'),300); } }; body.appendChild(row); } }
    function spawnParticle(src, n) { if (!userSettings.particles) return; const rect = src.getBoundingClientRect(); const dest = scoreEl.getBoundingClientRect(); const area = document.getElementById('game-area').getBoundingClientRect(); for(let i=0; i<n; i++) { const p = document.createElement('div'); p.className = 'particle'; const s = Math.random()*8+4; p.style.width=s+'px'; p.style.height=s+'px'; p.style.left = (rect.left - area.left + rect.width/2)+'px'; p.style.top = (rect.top - area.top + rect.height/2)+'px'; const tx = (dest.left - rect.left) + (Math.random()-0.5)*50; const ty = (dest.top - rect.top) + (Math.random()-0.5)*50; p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); partCont.appendChild(p); setTimeout(()=>p.remove(), 1000); } }
    function spawnPassive() { if (!userSettings.particles) return; const rect = storeEl.getBoundingClientRect(); const dest = scoreEl.getBoundingClientRect(); const p = document.createElement('div'); p.className='passive-particle'; const s = Math.random()*3+2; p.style.width=s+'px'; p.style.height=s+'px'; const startY = Math.random() * window.innerHeight; p.style.left = rect.left+'px'; p.style.top = startY+'px'; const tx = dest.left - rect.left + 50; const ty = (dest.top + 20) - startY; p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); passPartCont.appendChild(p); setTimeout(()=>p.remove(), 2000); }

    function render() { 
      try { 
        if(lastState) { 
          const delta = Date.now() - lastUpdate; 
          const cps = lastState.cellsPerSecond || 0; 
          const pred = lastState.totalInfectedCells + (cps/1000 * delta); 
          currentScore = Math.floor(pred); 
          scoreEl.innerText = isNaN(currentScore) ? "0" : formatNumber(currentScore); 
          
          document.title = formatNumber(currentScore) + " CI - Gen√®se";

          for(let k in builds) { 
              const el = document.getElementById(builds[k]); 
              if(el) { 
                const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0);
                const count = parseInt(el.querySelector('.item-count').innerText || 0);
                const threshold = cost * 0.6; 
                
                if (count > 0 || currentScore >= threshold) {
                  if (!el.classList.contains('revealed')) {
                      el.classList.add('revealed');
                  }
                }

                if (el.classList.contains('revealed')) {
                    el.style.opacity = (currentScore >= cost) ? 1 : 0.5; 
                    el.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed'; 
                }
              } 
          }
          
          const bItems = document.getElementsByClassName('boost-item'); 
          for(let b of bItems) { 
              const cost = parseFloat(b.dataset.cost); 
              b.style.opacity = (currentScore >= cost) ? 1 : 0.5; 
              b.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed'; 
          } 
          
          if(cps > 0 && userSettings.particles) { 
              const chance = Math.log10(cps+1) * 0.05; 
              if(Math.random() < chance) spawnPassive(); 
          } 
        } 
      } catch(e) { 
          console.error("Erreur rendu", e); 
      } 
      requestAnimationFrame(render); 
    } 
    requestAnimationFrame(render);

    (function initBioBackground() {
      const canvas = document.getElementById('bio-canvas');
      const ctx = canvas.getContext('2d');
      let w, h;
      
      class BioParticle {
        constructor() {
          this.x = Math.random() * w;
          this.y = Math.random() * h;
          this.vx = (Math.random() - 0.5) * 0.5;
          this.vy = (Math.random() - 0.5) * 0.5;
          this.radius = Math.random() * 15 + 5;
          this.alpha = Math.random() * 0.1 + 0.05;
          this.pulseSpeed = Math.random() * 0.02 + 0.005;
          this.pulse = 0;
        }
        update() {
          this.x += this.vx;
          this.y += this.vy;
          this.pulse += this.pulseSpeed;
          if(this.x < -50) this.x = w+50; if(this.x > w+50) this.x = -50;
          if(this.y < -50) this.y = h+50; if(this.y > h+50) this.y = -50;
        }
        draw() {
          const r = this.radius + Math.sin(this.pulse) * 2;
          ctx.beginPath();
          ctx.arc(this.x, this.y, r, 0, Math.PI*2);
          ctx.fillStyle = `rgba(63, 185, 80, ${this.alpha})`;
          ctx.fill();
          ctx.beginPath();
          ctx.arc(this.x, this.y, r * 0.4, 0, Math.PI*2);
          ctx.fillStyle = `rgba(63, 185, 80, ${this.alpha + 0.1})`;
          ctx.fill();
        }
      }
      
      const particles = [];
      const numParticles = 40;
      
      function resize() {
        w = canvas.width = window.innerWidth;
        h = canvas.height = window.innerHeight;
      }
      window.addEventListener('resize', resize);
      resize();
      
      for(let i=0; i<numParticles; i++) particles.push(new BioParticle());
      
      function animate() {
        ctx.clearRect(0, 0, w, h);
        
        ctx.strokeStyle = 'rgba(63, 185, 80, 0.05)';
        ctx.lineWidth = 1;
        for(let i=0; i<particles.length; i++) {
          const p1 = particles[i];
          p1.update();
          p1.draw();
          for(let j=i+1; j<particles.length; j++) {
            const p2 = particles[j];
            const dx = p1.x - p2.x;
            const dy = p1.y - p2.y;
            const dist = Math.sqrt(dx*dx + dy*dy);
            if(dist < 150) {
              ctx.beginPath();
              ctx.moveTo(p1.x, p1.y);
              ctx.lineTo(p2.x, p2.y);
              ctx.stroke();
            }
          }
        }
        requestAnimationFrame(animate);
      }
      animate();
    })();
  </script>
</body>
</html>