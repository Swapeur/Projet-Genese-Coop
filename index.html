<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Laboratoire Viral - Multijoueur</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root { --bg-color: #0d1117; --panel-bg: #161b22; --border-color: #30363d; --text-color: #c9d1d9; --title-color: #58a6ff; --viral-green: #3fb950; --viral-glow: rgba(63, 185, 80, 0.5); --prestige-color: #ffc107; --prestige-glow: rgba(255, 193, 7, 0.5); --error-color: #e63946; }
    * { box-sizing: border-box; user-select: none; }
    body { 
      font-family: 'Share Tech Mono', monospace; 
      background-color: var(--bg-color); 
      color: var(--text-color); 
      margin: 0; 
      padding: 0; 
      overflow: hidden; 
      /* NOUVEAU: Transition de couleur */
      transition: filter 2s ease-out;
    }
    h1, h2, h3, h4, p { margin: 0; padding: 0; }
    /* --- TITRE h1 MODIFI√â --- */
    h1 { 
      color: var(--title-color); 
      border-bottom: 1px solid var(--border-color); 
      padding: 15px 0; 
      text-align: center; 
      font-size: 2.2em;
      text-shadow: 0 0 10px rgba(88, 166, 255, 0.6), 0 0 20px rgba(88, 166, 255, 0.3);
      transform: scale(1.05) perspective(1px) translateY(-2px);
      transition: all 0.5s ease;
      width: 100%;
      flex-shrink: 0;
    }
    /* ------------------------ */
    
    .container { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 10; }
    #game-area { 
      flex-grow: 1; 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      justify-content: space-around; 
      height: 100%; 
      border-right: 2px solid var(--border-color); 
      position: relative; 
      z-index: 20; 
      padding-top: 10px; 
      padding-bottom: 10px;
    }
    #store-area { width: 350px; min-width: 350px; background-color: var(--panel-bg); height: 100%; overflow-y: auto; padding: 10px; z-index: 20; display: flex; flex-direction: column; gap: 10px; }

    #login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 10000; display: flex; flex-direction: column; justify-content: center; align-items: center; }
    #login-box { background: var(--panel-bg); border: 2px solid var(--title-color); padding: 40px; border-radius: 10px; text-align: center; box-shadow: 0 0 50px rgba(88, 166, 255, 0.2); }
    #login-box h2 { color: var(--title-color); margin-bottom: 20px; border: none; }
    #login-input { padding: 10px; font-family: inherit; font-size: 1.2em; background: #0d1117; border: 1px solid var(--border-color); color: #fff; width: 250px; text-align: center; margin-bottom: 20px; outline: none; }
    #login-input:focus { border-color: var(--viral-green); }
    #login-btn { padding: 10px 30px; font-family: inherit; font-size: 1.2em; font-weight: bold; background: var(--viral-green); border: none; color: #000; cursor: pointer; border-radius: 5px; }
    #login-btn:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--viral-glow); }

    #background-cells { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; background: var(--bg-color); pointer-events: none; }
    .bg-cell { position: absolute; border-radius: 50%; background: radial-gradient(circle, rgba(63, 185, 80, 0.05) 0%, transparent 70%); filter: blur(10px); animation: float 20s infinite ease-in-out; }
    @keyframes float { 0% { transform: translate(0,0); } 50% { transform: translate(20px, -20px); } 100% { transform: translate(0,0); } }

    .score-panel { 
      background-color: var(--panel-bg); 
      border: 1px solid var(--border-color); 
      padding: 15px 40px; 
      border-radius: 8px; 
      /* MODIFIE: Ombre plus profonde */
      box-shadow: 0 0 15px rgba(0,0,0,0.8), inset 0 0 8px rgba(255, 255, 255, 0.05); 
      margin-top: 0; 
      margin-bottom: 0; 
      text-align: center; 
    }
    #scoreDisplay { 
      font-size: 3.5em; 
      color: var(--viral-green); 
      /* MODIFIE: Ombre n√©on plus puissante */
      text-shadow: 0 0 10px var(--viral-glow), 0 0 20px rgba(63, 185, 80, 0.8);
      font-variant-numeric: tabular-nums; 
      transition: transform 0.1s; 
      display: block; 
    }
    #scoreDisplay.pop { transform: scale(1.1); color: #fff; }
    .score-label { font-size: 1.2em; margin-top: 5px; color: #8b949e; }
    #cps-display { color: var(--viral-green); font-size: 1.5em; margin-top: 10px; font-weight: bold; font-variant-numeric: tabular-nums; }
    
    /* --- MODIFICATION de #player-count --- */
    #player-count { 
      position: absolute; 
      top: 15px; 
      right: 20px; 
      font-size: 1.2em; 
      color: var(--viral-green); 
      font-weight: bold; 
      text-shadow: 0 0 8px var(--viral-glow);
    }
    /* -------------------------------------- */

    #cell-button { 
      width: 220px; 
      height: 220px; 
      background: radial-gradient(circle, #2a5a2f 0%, var(--viral-green) 10%, #1e3f20 70%); 
      border-radius: 50%; 
      border: 4px solid var(--viral-green); 
      /* MODIFIE: Ombre plus large et profondeur */
      box-shadow: 
        0 0 40px var(--viral-glow), 
        0 0 15px var(--viral-green), 
        inset 0 0 20px #1e3f20; 
      cursor: pointer; 
      transition: transform 0.05s, filter 0.2s; 
      position: relative; 
      z-index: 25; 
    }
    #cell-button:active { transform: scale(0.95); }
    #cell-button.clicked { animation: cellClickAnim 0.1s; }
    @keyframes cellClickAnim { 0% { transform: scale(0.95); } 100% { transform: scale(1); } }
    #click-info { margin-top: 15px; color: #8b949e; font-size: 1em; text-align: center; font-variant-numeric: tabular-nums; }

    .float-text { position: absolute; color: #fff; font-weight: bold; font-size: 1.4em; pointer-events: none; animation: floatUp 0.8s forwards; text-shadow: 0 0 5px #000; z-index: 1000; }
    @keyframes floatUp { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.3); } }

    #particle-container, #passive-particle-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15; }
    .particle { position: absolute; width: 8px; height: 8px; background: var(--viral-green); border-radius: 50%; animation: particleFly 1s forwards; opacity: 0; }
    .passive-particle { position: absolute; width: 4px; height: 4px; background: var(--viral-green); border-radius: 50%; animation: passiveFly 2s forwards; opacity: 0; }
    @keyframes particleFly { 0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }
    @keyframes passiveFly { 0% { opacity: 0.6; } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } }

    .bonus-mutation { position: absolute; font-size: 4em; cursor: pointer; filter: drop-shadow(0 0 10px var(--viral-green)); animation: pulseBonus 0.5s infinite alternate, popIn 0.3s ease-out; z-index: 1000; user-select: none; }
    @keyframes pulseBonus { 0% { transform: scale(1); } 100% { transform: scale(1.1); } }
    @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }

    h2 { color: var(--text-color); margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--title-color); }
    .store-item { background-color: #21262d; border: 1px solid var(--border-color); border-radius: 5px; padding: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: background 0.2s, border-color 0.2s; }
    .store-item:hover { background-color: #30363d; border-color: var(--title-color); }
    .store-item.purchased-anim { animation: flashGreen 0.3s; } .store-item.error-anim { animation: shakeRed 0.3s; }
    .item-info h3 { font-size: 1em; color: var(--text-color); } .item-desc { font-size: 0.8em; color: #8b949e; font-style: italic; margin-top: 2px; } .item-gain { font-size: 0.85em; color: var(--viral-green); margin-top: 2px; }
    .item-stats { text-align: right; min-width: 80px; } .item-cost { display: block; font-size: 1em; color: var(--viral-green); font-weight: bold; } .item-count { display: block; font-size: 1.4em; color: #fff; font-weight: bold; margin-top: 2px; }

    #boost-area { background: #21262d; border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; min-height: 60px; }
    #boost-container { display: flex; flex-wrap: wrap; gap: 5px; }
    .boost-item { width: 45px; height: 45px; background: #30363d; border: 2px solid var(--title-color); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5em; cursor: pointer; transition: transform 0.2s; }
    .boost-item:hover { transform: scale(1.1); border-color: var(--viral-green); } .boost-item.error-anim { animation: shakeRed 0.3s; }

    #prestige-area { display: none; background: #21262d; border: 1px solid var(--prestige-color); border-radius: 5px; padding: 10px; text-align: center; }
    #prestige-area h3 { color: var(--prestige-color); border: none; padding: 0; }
    .prestige-btn { background: var(--prestige-color); color: #000; border: none; padding: 8px; width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px; font-family: inherit; }
    .prestige-btn:hover { background: #ffd54f; } .prestige-btn.secondary { background: var(--title-color); color: white; }

    #modal-backdrop { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center; }
    #modal { width: 600px; max-height: 80vh; background: var(--bg-color); border: 2px solid var(--prestige-color); border-radius: 10px; display: flex; flex-direction: column; }
    #modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: center; }
    #modal-header h2 { color: var(--prestige-color); } #modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    .p-upgrade { background: var(--panel-bg); border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .p-upgrade:hover { background: #30363d; border-color: var(--prestige-color); } .p-upgrade.purchased { opacity: 0.5; cursor: default; border-color: var(--viral-green); } .p-upgrade.disabled { opacity: 0.5; cursor: not-allowed; }

    #tooltip { display: none; position: absolute; background: var(--panel-bg); border: 1px solid var(--title-color); padding: 10px; width: 220px; z-index: 9999; pointer-events: none; border-radius: 5px; box-shadow: 0 5px 20px #000; }
    #tooltip h4 { color: var(--title-color); margin-bottom: 5px; } #tooltip .cost { color: var(--viral-green); font-weight: bold; margin-bottom: 5px; } #tooltip .desc { color: #ccc; font-size: 0.9em; font-style: italic; } #tooltip .stats { margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; font-size: 0.85em; color: #aaa; }
    @keyframes flashGreen { 0% { background-color: var(--viral-green); } 100% { background-color: #21262d; } } @keyframes shakeRed { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); border-color: var(--error-color); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }

    #chat-container { position: absolute; bottom: 10px; left: 10px; width: 320px; height: 230px; background: rgba(13, 17, 23, 0.95); border: 1px solid var(--border-color); border-radius: 5px; display: flex; flex-direction: column; z-index: 100; pointer-events: auto; }
    #chat-header { padding: 5px; border-bottom: 1px solid var(--border-color); background: rgba(0,0,0,0.3); color: var(--viral-green); font-size: 0.9em; font-weight: bold; }
    #chat-messages { flex-grow: 1; overflow-y: auto; padding: 8px; font-size: 0.85em; display: flex; flex-direction: column; gap: 4px; scrollbar-width: thin; scrollbar-color: var(--border-color) var(--bg-color); }
    .msg { word-wrap: break-word; } .msg-user { color: var(--title-color); font-weight: bold; } .msg-text { color: var(--text-color); } .msg-system { color: var(--error-color); font-style: italic; }
    #chat-form { display: flex; border-top: 1px solid var(--border-color); }
    #chat-input { flex-grow: 1; background: transparent; border: none; padding: 8px; color: #fff; font-family: inherit; outline: none; }
    #chat-btn { background: var(--panel-bg); border: none; border-left: 1px solid var(--border-color); color: var(--title-color); padding: 0 10px; cursor: pointer; font-family: inherit; transition: opacity 0.2s; }
    #chat-btn:hover { background: #30363d; }

    #leaderboard-panel { position: absolute; top: 80px; left: 20px; width: 200px; background: rgba(13, 17, 23, 0.8); border: 1px solid var(--border-color); border-radius: 5px; padding: 10px; z-index: 50; pointer-events: none; }
    #leaderboard-panel h3 { font-size: 1em; color: var(--title-color); margin-bottom: 5px; text-align: center; }
    #leaderboard-list { list-style: none; padding: 0; margin: 0; font-size: 0.85em; }
    #leaderboard-list li { display: flex; justify-content: space-between; padding: 2px 0; border-bottom: 1px solid #222; }
    .lb-name { color: #fff; font-weight: bold; } .lb-score { color: var(--viral-green); }
  </style>
</head>
<body>
  <div id="login-overlay">
    <div id="login-box"><h2>IDENTIFICATION REQUISE</h2><p style="color: #8b949e; margin-bottom: 20px;">Acc√®s au Laboratoire</p><form id="login-form"><input type="text" id="login-input" placeholder="Votre Nom de Code" maxlength="15" autocomplete="off"><br><button type="submit" id="login-btn">ACC√âDER</button></form></div>
  </div>
  <div id="background-cells"><div class="bg-cell" style="width:300px; height:300px; top:10%; left:10%;"></div><div class="bg-cell" style="width:500px; height:500px; top:50%; left:60%;"></div></div>
  <div id="passive-particle-container"></div>
  <div class="container">
    <div id="game-area">
      <h1>Projet : Genese</h1><div id="player-count">Scientifiques : 0</div>
      <div class="score-panel"><div id="scoreDisplay">0</div><p class="score-label">Cellules Infect√©es</p><div id="cps-display">+0 CI/s</div></div>
      <div id="leaderboard-panel"><h3>Top Contributeurs</h3><ul id="leaderboard-list"></ul></div>
      <div id="cell-button"></div><div id="click-info">Puissance Clic: +1</div> 
      <div id="particle-container"></div>
      <div id="chat-container"><div id="chat-header">Badge: <span id="current-username-display">Anonyme</span></div><div id="chat-messages"><div class="msg"><span class="msg-user">Syst√®me:</span> <span class="msg-text">Connexion √©tablie.</span></div></div><form id="chat-form"><input type="text" id="chat-input" placeholder="D√©bloquez le chat (50 clics)..." autocomplete="off"><button type="submit" id="chat-btn">></button></form></div>
    </div>
    <div id="store-area">
      <div id="prestige-area"><h3>Recherche Avanc√©e</h3><p>+<span id="p-gain">0</span> PR au reset</p><p>Total: <span id="p-total">0</span> PR</p><button class="prestige-btn secondary" id="btn-meta">M√©ta-Recherche (üß†)</button><button class="prestige-btn" id="btn-reset">Lancer la Mutation Globale</button></div>
      <div id="boost-area"><h3>Recherche</h3><div id="boost-container"></div></div>
      <h2>Am√©liorations</h2>
      <div class="store-item" id="b-mutation"><div class="item-info"><h3>Mutation Mineure</h3><p class="item-desc">Ajustements d'ADN.</p><p class="item-gain">+0.1 CI/s</p></div><div class="item-stats"><span class="item-cost">15</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-oiseau"><div class="item-info"><h3>Vecteur Oiseau</h3><p class="item-desc">Grippe 2.0.</p><p class="item-gain">+1 CI/s</p></div><div class="item-stats"><span class="item-cost">100</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-eau"><div class="item-info"><h3>Contamination Eau</h3><p class="item-desc">Eau trouble.</p><p class="item-gain">+8 CI/s</p></div><div class="item-stats"><span class="item-cost">1100</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-aerosol"><div class="item-info"><h3>Transmission A√©rosol</h3><p class="item-desc">Dans l'air.</p><p class="item-gain">+47 CI/s</p></div><div class="item-stats"><span class="item-cost">12000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-aeroport"><div class="item-info"><h3>A√©roport International</h3><p class="item-desc">Vols infect√©s.</p><p class="item-gain">+260 CI/s</p></div><div class="item-stats"><span class="item-cost">130000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-ferme"><div class="item-info"><h3>Fermes Virales</h3><p class="item-desc">Culture intensive.</p><p class="item-gain">+2k CI/s</p></div><div class="item-stats"><span class="item-cost">500000</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-centre"><div class="item-info"><h3>Centres de Contagion</h3><p class="item-desc">Villes denses.</p><p class="item-gain">+15k CI/s</p></div><div class="item-stats"><span class="item-cost">5M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-propagande"><div class="item-info"><h3>Propagande Virale</h3><p class="item-desc">Fake news.</p><p class="item-gain">+100k CI/s</p></div><div class="item-stats"><span class="item-cost">50M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-satellite"><div class="item-info"><h3>Satellite de Dispersion</h3><p class="item-desc">5G Virale.</p><p class="item-gain">+1.2M CI/s</p></div><div class="item-stats"><span class="item-cost">600M</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-clonage"><div class="item-info"><h3>Clonage Humain</h3><p class="item-desc">Copier/Coller.</p><p class="item-gain">+20M CI/s</p></div><div class="item-stats"><span class="item-cost">7.5Md</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-terraformation"><div class="item-info"><h3>Terraformation Virale</h3><p class="item-desc">Plan√®te morte.</p><p class="item-gain">+350M CI/s</p></div><div class="item-stats"><span class="item-cost">95Md</span><span class="item-count">0</span></div></div>
      <div class="store-item" id="b-singularite"><div class="item-info"><h3>Singularit√© Biologique</h3><p class="item-desc">La Fin.</p><p class="item-gain">+8Md CI/s</p></div><div class="item-stats"><span class="item-cost">1.5Tn</span><span class="item-count">0</span></div></div>
    </div>
  </div>
  <div id="tooltip"></div><div id="modal-backdrop"><div id="modal"><div id="modal-header"><h2>M√©ta-Recherche</h2><p>Am√©liorations permanentes</p></div><div id="modal-body"></div></div></div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    // GENERATION DU DEVICE ID
    let deviceId = localStorage.getItem('viral_device_id');
    if (!deviceId) {
      deviceId = 'id_' + Math.random().toString(36).substr(2, 9) + Date.now();
      localStorage.setItem('viral_device_id', deviceId);
    }

    const socket = io({ auth: { token: deviceId } });
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const Sound = {
      click: () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(400, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.15); gain.gain.setValueAtTime(0.3, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.15); osc.start(); osc.stop(audioCtx.currentTime + 0.15); },
      buy: () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'triangle'; osc.frequency.setValueAtTime(200, audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(600, audioCtx.currentTime + 0.1); gain.gain.setValueAtTime(0.1, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); },
      chat: () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(800, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1); osc.start(); osc.stop(audioCtx.currentTime + 0.1); },
      bonus: () => { if(audioCtx.state === 'suspended') audioCtx.resume(); const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.connect(gain); gain.connect(audioCtx.destination); osc.type = 'sine'; osc.frequency.setValueAtTime(600, audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.3); gain.gain.setValueAtTime(0.2, audioCtx.currentTime); gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3); osc.start(); osc.stop(audioCtx.currentTime + 0.3); }
    };

    let lastState = null; let lastUpdate = Date.now(); let currentScore = 0; let currentClickValue = 1;
    const scoreEl = document.getElementById('scoreDisplay'); const cellBtn = document.getElementById('cell-button'); const tooltip = document.getElementById('tooltip'); const partCont = document.getElementById('particle-container'); const passPartCont = document.getElementById('passive-particle-container'); const storeEl = document.getElementById('store-area'); const leaderboardList = document.getElementById('leaderboard-list');
    
    function formatNumber(num) { 
      if (num < 1000) return parseFloat(num.toFixed(1));
      if (num < 1000000) return parseFloat((num / 1000).toFixed(2)) + 'k'; 
      if (num < 1000000000) return parseFloat((num / 1000000).toFixed(2)) + 'M'; 
      if (num < 1000000000000) return parseFloat((num / 1000000000).toFixed(2)) + 'Md'; 
      if (num < 1000000000000000) return parseFloat((num / 1000000000000).toFixed(2)) + 'T'; 
      return parseFloat((num / 1000000000000000).toFixed(2)) + 'Qa'; 
    }

    const loginOverlay = document.getElementById('login-overlay'); const loginForm = document.getElementById('login-form'); const loginInput = document.getElementById('login-input'); const currentUsernameDisplay = document.getElementById('current-username-display');
    loginForm.onsubmit = (e) => { e.preventDefault(); const name = loginInput.value.trim(); if(name.length > 0) { if(audioCtx.state === 'suspended') audioCtx.resume(); socket.emit('set_username', name); currentUsernameDisplay.innerText = name; loginOverlay.style.display = 'none'; } else { loginInput.style.borderColor = "var(--error-color)"; setTimeout(() => loginInput.style.borderColor = "var(--border-color)", 300); } };
    
    const chatForm = document.getElementById('chat-form'); 
    const chatInput = document.getElementById('chat-input'); 
    const chatMsg = document.getElementById('chat-messages');
    const chatBtn = document.getElementById('chat-btn');

    chatForm.onsubmit = (e) => { 
      e.preventDefault(); 
      const txt = chatInput.value; 
      if(txt.trim() && !chatBtn.disabled) { 
        socket.emit('chat_message', txt); 
        chatInput.value = ''; 
        chatBtn.disabled = true;
        chatBtn.style.opacity = '0.5';
        chatBtn.style.cursor = 'not-allowed';
        setTimeout(() => {
          chatBtn.disabled = false;
          chatBtn.style.opacity = '1';
          chatBtn.style.cursor = 'pointer';
        }, 2000); 
      } 
    };

    socket.on('chat_message', (d) => { 
      const div = document.createElement('div'); 
      div.className = 'msg'; 
      div.innerHTML = `<span class="msg-user"></span>: <span class="msg-text"></span>`; 
      div.querySelector('.msg-user').innerText = d.user; 
      div.querySelector('.msg-text').innerText = d.text; 
      chatMsg.appendChild(div); 
      chatMsg.scrollTop = chatMsg.scrollHeight; 
      Sound.chat(); 
    });

    socket.on('chat_error', (msg) => {
      const div = document.createElement('div'); 
      div.className = 'msg'; 
      div.innerHTML = `<span class="msg-system">‚õî Syst√®me: ${msg}</span>`; 
      chatMsg.appendChild(div); 
      chatMsg.scrollTop = chatMsg.scrollHeight; 
    });

    socket.on('spawn_bonus', (data) => {
      const bonus = document.createElement('div');
      bonus.className = 'bonus-mutation';
      bonus.innerText = '‚ò£Ô∏è'; 
      const x = Math.random() * (window.innerWidth - 100) + 50;
      const y = Math.random() * (window.innerHeight - 100) + 50;
      bonus.style.left = x + 'px';
      bonus.style.top = y + 'px';
      bonus.id = data.id; 
      bonus.onclick = (e) => {
        if(!e.isTrusted) return; 
        socket.emit('click_bonus', data.id);
        Sound.bonus();
        bonus.remove(); 
        spawnFloatingText(e, "MUTATION !");
      };
      document.body.appendChild(bonus);
      setTimeout(() => { if(bonus.parentNode) bonus.remove(); }, 10000);
    });

    const builds = { 'mutation_mineure': 'b-mutation', 'vecteur_oiseau': 'b-oiseau', 'contamination_eau': 'b-eau', 'transmission_aerosol': 'b-aerosol', 'aeroport_international': 'b-aeroport', 'fermes_virales': 'b-ferme', 'centres_contagion': 'b-centre', 'propagande_virale': 'b-propagande', 'satellite_dispersion': 'b-satellite', 'clonage_humain': 'b-clonage', 'terraformation_virale': 'b-terraformation', 'singularite_biologique': 'b-singularite' };
    function showTip(e, title, cost, desc, gain, total) { let h = `<h4>${title}</h4><div class="cost" style="color:var(--viral-green)">Co√ªt: ${formatNumber(cost)} CI</div><div class="desc">${desc}</div>`; if(gain) h += `<div class="stats">Gain: ${formatNumber(gain)} CI/s<br>Total: ${formatNumber(total)} CI/s</div>`; tooltip.innerHTML = h; tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px'; tooltip.style.display = 'block'; }
    function hideTip() { tooltip.style.display = 'none'; } function moveTip(e) { tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px'; }
    for(let k in builds) { const el = document.getElementById(builds[k]); el.onclick = () => { if(!lastState) return; const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0); if(currentScore >= cost) { socket.emit('buy_upgrade', k); el.classList.add('purchased-anim'); setTimeout(()=>el.classList.remove('purchased-anim'),300); Sound.buy(); } else { el.classList.add('error-anim'); setTimeout(()=>el.classList.remove('error-anim'),300); } }; el.onmouseenter = (e) => { if(!lastState) return; let costKey = 'cost_' + k.split('_')[0].replace('vecteur','oiseau').replace('contamination','eau').replace('transmission','aerosol').replace('aeroport','aeroport').replace('fermes','ferme').replace('centres','centre').replace('propagande','propagande'); if(k.startsWith('satellite')) costKey = 'cost_satellite'; if(k.startsWith('clonage')) costKey = 'cost_clonage'; if(k.startsWith('terraformation')) costKey = 'cost_terraformation'; if(k.startsWith('singularite')) costKey = 'cost_singularite'; const gainKey = costKey.replace('cost','gain'); const name = el.querySelector('h3').innerText; const desc = el.querySelector('.item-desc').innerText; const cost = parseFloat(el.querySelector('.item-cost').dataset.raw); const gain = parseFloat(el.querySelector('.item-gain').dataset.raw); let countKey = k; if(k=='mutation_mineure') countKey='mutations_mineures'; if(k=='vecteur_oiseau') countKey='vecteurs_oiseaux'; const count = lastState[countKey] || 0; showTip(e, name, cost, desc, gain, gain*count); }; el.onmousemove = moveTip; el.onmouseleave = hideTip; }
    
    cellBtn.onclick = (e) => { 
      if (!e.isTrusted) return; 
      socket.emit('click_cell'); 
      cellBtn.classList.add('clicked'); 
      setTimeout(()=>cellBtn.classList.remove('clicked'),100); 
      spawnParticle(cellBtn, 5); 
      spawnFloatingText(e, currentClickValue); 
      Sound.click(); 
    };

    function spawnFloatingText(e, amount) { 
      const el = document.createElement('div'); 
      el.className = 'float-text'; 
      el.innerText = (typeof amount === 'string' ? '' : '+') + (typeof amount === 'number' ? formatNumber(amount) : amount); 
      let x = e.clientX; let y = e.clientY; 
      if(!x && !y) { const rect = cellBtn.getBoundingClientRect(); x = rect.left + rect.width/2; y = rect.top + rect.height/2; } 
      x += (Math.random() - 0.5) * 30; 
      el.style.left = x + 'px'; el.style.top = y + 'px'; 
      document.body.appendChild(el); 
      setTimeout(() => el.remove(), 800); 
    }

    document.getElementById('btn-reset').onclick = () => { if(confirm('Prestige ? Reset complet vs PR.')) socket.emit('do_prestige'); }; document.getElementById('btn-meta').onclick = () => { document.getElementById('modal-backdrop').style.display = 'flex'; renderPrestigeShop(); }; document.getElementById('modal-backdrop').onclick = (e) => { if(e.target.id === 'modal-backdrop') e.target.style.display = 'none'; };

    socket.on('tick_update', (d) => { 
      if(!lastState) return; 
      lastState.totalInfectedCells = d.score; 
      lastState.cellsPerSecond = d.cps; 
      currentClickValue = d.clickValue; 
      lastUpdate = Date.now(); 
      
      // DYNAMISME VISUEL : Changement de couleur bas√© sur le score total
      const logScore = Math.log10(lastState.totalCellsEver + 1);
      const hue = (logScore * 10) % 360; 
      document.body.style.filter = `hue-rotate(${hue}deg)`;

      document.getElementById('player-count').innerText = 'Scientifiques: ' + d.players; 
      document.getElementById('cps-display').innerText = '+' + formatNumber(d.cps) + ' CI/s'; 
      document.getElementById('click-info').innerText = 'Puissance Clic: +' + formatNumber(d.clickValue); 
      
      if(d.leaderboard) { 
        leaderboardList.innerHTML = ''; 
        d.leaderboard.forEach(p => { 
          const li = document.createElement('li'); 
          li.innerHTML = `<span class="lb-name">${p.name}</span> <div style="text-align:right"><span class="lb-score">${formatNumber(p.contribution)}</span><small style="color:#666; font-size:0.8em; margin-left:5px;">(${p.clicks} üñ±Ô∏è)</small></div>`; 
          leaderboardList.appendChild(li); 
        }); 
      } 
      
      const hue_cell = Math.min(d.clickHeat*0.8, 120); 
      cellBtn.style.filter = `hue-rotate(${hue_cell}deg)`; 
    });

    socket.on('full_update', (d) => { lastState = d.gameState; lastUpdate = Date.now(); prestigeUpgradesList = d.prestigeUpgrades; const s = lastState; const update = (key, cKey, gKey, cntKey) => { const el = document.getElementById(builds[key]); if(el) { const cost = s[cKey]; const gain = s[gKey]; const count = s[cntKey]; el.querySelector('.item-cost').innerText = formatNumber(cost); el.querySelector('.item-cost').dataset.raw = cost; el.querySelector('.item-count').innerText = count; el.querySelector('.item-gain').innerText = `+${formatNumber(gain)} CI/s`; el.querySelector('.item-gain').dataset.raw = gain; } }; update('mutation_mineure', 'cost_mutation', 'gain_mutation', 'mutations_mineures'); update('vecteur_oiseau', 'cost_oiseau', 'gain_oiseau', 'vecteurs_oiseaux'); update('contamination_eau', 'cost_eau', 'gain_eau', 'contamination_eau'); update('transmission_aerosol', 'cost_aerosol', 'gain_aerosol', 'transmission_aerosol'); update('aeroport_international', 'cost_aeroport', 'gain_aeroport', 'aeroport_international'); update('fermes_virales', 'cost_ferme', 'gain_ferme', 'fermes_virales'); update('centres_contagion', 'cost_centre', 'gain_centre', 'centres_contagion'); update('propagande_virale', 'cost_propagande', 'gain_propagande', 'propagande_virale'); update('satellite_dispersion', 'cost_satellite', 'gain_satellite', 'satellite_dispersion'); update('clonage_humain', 'cost_clonage', 'gain_clonage', 'clonage_humain'); update('terraformation_virale', 'cost_terraformation', 'gain_terraformation', 'terraformation_virale'); update('singularite_biologique', 'cost_singularite', 'gain_singularite', 'singularite_biologique'); const boostCont = document.getElementById('boost-container'); boostCont.innerHTML = ''; for(const b of d.availableBoosts) { const el = document.createElement('div'); el.className = 'boost-item'; let ico = '‚ùì'; if(b.id.includes('seringue') || b.id.includes('gants')) ico='üß§'; else if(b.id.includes('doigts')) ico='ü¶æ'; else if(b.id.includes('rage')) ico='ü©∏'; else if(b.id.includes('osmose')) ico='‚ö°'; else if(b.id.includes('neurones')) ico='üß†'; else if(b.id.includes('clics')) ico='üñ±Ô∏è'; else if(b.id.includes('mutation')) ico='üß¨'; else if(b.id.includes('plumes')||b.id.includes('oiseau')) ico='ü™∂'; else if(b.id.includes('filtres')||b.id.includes('eau')) ico='üíß'; else if(b.id.includes('spores')||b.id.includes('aerosol')) ico='üí®'; else if(b.id.includes('partenariats')||b.id.includes('aeroport')) ico='‚úàÔ∏è'; else if(b.id.includes('nutriments')||b.id.includes('ferme')) ico='üåø'; else if(b.id.includes('gentrification')||b.id.includes('centre')) ico='üèôÔ∏è'; else if(b.id.includes('fake')||b.id.includes('propagande')) ico='üì∞'; else if(b.id.includes('sat')) ico='üì°'; else if(b.id.includes('clone')) ico='üëØ'; else if(b.id.includes('terra')) ico='üåç'; else if(b.id.includes('singu')) ico='üåå'; else if(b.id.includes('matrice')) ico='üí†'; else if(b.id.includes('synergie')) ico='üîó'; else if(b.id.includes('contamination')) ico='‚ò£Ô∏è'; el.innerText = ico; el.onclick = () => { let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; if(currentScore >= cost) { socket.emit('buy_boost', b.id); el.remove(); Sound.buy(); } else { el.classList.add('error-anim'); setTimeout(()=>el.classList.remove('error-anim'),300); } }; el.onmouseenter = (e) => { let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; showTip(e, b.name, cost, b.description); }; el.onmousemove = moveTip; el.onmouseleave = hideTip; let cost = b.cost; if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9; el.dataset.cost = cost; boostCont.appendChild(el); } const pInfo = d.prestigeInfo; const pArea = document.getElementById('prestige-area'); if(pInfo.canPrestige || s.prestigePoints > 0) { pArea.style.display = 'block'; document.getElementById('p-gain').innerText = formatNumber(pInfo.pointsOnReset); document.getElementById('p-total').innerText = formatNumber(s.prestigePoints); } else { pArea.style.display = 'none'; } renderPrestigeShop(); });
    function renderPrestigeShop() { if(!lastState) return; const body = document.getElementById('modal-body'); body.innerHTML = ''; for(const id in prestigeUpgradesList) { const u = prestigeUpgradesList[id]; const row = document.createElement('div'); row.className = 'p-upgrade'; row.innerHTML = `<div><h4>${u.name}</h4><div class="description">${u.description}</div></div><div class="cost">${u.cost} PR</div>`; const isBought = lastState.purchasedPrestigeUpgrades.includes(id); const canBuy = lastState.prestigePoints >= u.cost; if(isBought) row.classList.add('purchased'); else if(!canBuy) row.classList.add('disabled'); row.onclick = () => { if(!isBought && canBuy) { socket.emit('buy_prestige_upgrade', id); row.classList.add('purchased'); Sound.buy(); } else if (!isBought) { row.classList.add('error-anim'); setTimeout(()=>row.classList.remove('error-anim'),300); } }; body.appendChild(row); } }
    function spawnParticle(src, n) { const rect = src.getBoundingClientRect(); const dest = scoreEl.getBoundingClientRect(); const area = document.getElementById('game-area').getBoundingClientRect(); for(let i=0; i<n; i++) { const p = document.createElement('div'); p.className = 'particle'; const s = Math.random()*8+4; p.style.width=s+'px'; p.style.height=s+'px'; p.style.left = (rect.left - area.left + rect.width/2)+'px'; p.style.top = (rect.top - area.top + rect.height/2)+'px'; const tx = (dest.left - rect.left) + (Math.random()-0.5)*50; const ty = (dest.top - rect.top) + (Math.random()-0.5)*50; p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); partCont.appendChild(p); setTimeout(()=>p.remove(), 1000); } }
    function spawnPassive() { const rect = storeEl.getBoundingClientRect(); const dest = scoreEl.getBoundingClientRect(); const p = document.createElement('div'); p.className='passive-particle'; const s = Math.random()*3+2; p.style.width=s+'px'; p.style.height=s+'px'; const startY = Math.random() * window.innerHeight; p.style.left = rect.left+'px'; p.style.top = startY+'px'; const tx = dest.left - rect.left + 50; const ty = (dest.top + 20) - startY; p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px'); passPartCont.appendChild(p); setTimeout(()=>p.remove(), 2000); }

    function render() { try { if(lastState) { 
      const delta = Date.now() - lastUpdate; 
      const cps = lastState.cellsPerSecond || 0; 
      const pred = lastState.totalInfectedCells + (cps/1000 * delta); 
      currentScore = Math.floor(pred); 
      scoreEl.innerText = isNaN(currentScore) ? "0" : formatNumber(currentScore); 
      
      const logScore = Math.log10(lastState.totalCellsEver + 1);
      const hue = (logScore * 10) % 360; 
      document.body.style.filter = `hue-rotate(${hue}deg)`;

      for(let k in builds) { const el = document.getElementById(builds[k]); if(el) { const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0); el.style.opacity = (currentScore >= cost) ? 1 : 0.5; el.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed'; } } const bItems = document.getElementsByClassName('boost-item'); for(let b of bItems) { const cost = parseFloat(b.dataset.cost); b.style.opacity = (currentScore >= cost) ? 1 : 0.5; b.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed'; } if(cps > 0) { const chance = Math.log10(cps+1) * 0.05; if(Math.random() < chance) spawnPassive(); } } } catch(e) { console.error("Erreur rendu", e); } requestAnimationFrame(render); } requestAnimationFrame(render);
  </script>
</body>
</html>