<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Laboratoire Viral - Multijoueur</title>
  <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-color: #0d1117; --panel-bg: #161b22; --border-color: #30363d;
      --text-color: #c9d1d9; --title-color: #58a6ff; --viral-green: #3fb950;
      --viral-glow: rgba(63, 185, 80, 0.5);
      --prestige-color: #ffc107; --prestige-glow: rgba(255, 193, 7, 0.5);
      --error-color: #e63946;
    }
    * { box-sizing: border-box; user-select: none; }
    body { 
      font-family: 'Share Tech Mono', monospace; background-color: var(--bg-color);
      color: var(--text-color); margin: 0; padding: 0; overflow: hidden; 
    }
    h1, h2, h3, h4, p { margin: 0; padding: 0; }
    h1 { color: var(--title-color); border-bottom: 1px solid var(--border-color); padding: 10px 0; text-align: center; }
    
    /* LAYOUT */
    .container { display: flex; height: 100vh; width: 100vw; position: relative; z-index: 10; }
    
    /* GAUCHE */
    #game-area {
      flex-grow: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; height: 100%; border-right: 2px solid var(--border-color);
      position: relative; z-index: 20;
    }
    
    /* DROITE */
    #store-area {
      width: 350px; min-width: 350px; background-color: var(--panel-bg); height: 100%;
      overflow-y: auto; padding: 10px; z-index: 20;
      display: flex; flex-direction: column; gap: 10px;
    }

    /* BACKGROUND */
    #background-cells {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
      background: var(--bg-color); pointer-events: none;
    }
    .bg-cell {
      position: absolute; border-radius: 50%;
      background: radial-gradient(circle, rgba(63, 185, 80, 0.05) 0%, transparent 70%);
      filter: blur(10px); animation: float 20s infinite ease-in-out;
    }
    @keyframes float { 
      0% { transform: translate(0,0); } 50% { transform: translate(20px, -20px); } 100% { transform: translate(0,0); } 
    }

    /* SCORE */
    .score-panel {
      background-color: var(--panel-bg); border: 1px solid var(--border-color);
      padding: 15px 40px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.3);
      margin-bottom: 40px; text-align: center;
    }
    #scoreDisplay {
      font-size: 3.5em; color: var(--viral-green); text-shadow: 0 0 10px var(--viral-glow);
      font-variant-numeric: tabular-nums; transition: transform 0.1s; display: block;
    }
    #scoreDisplay.pop { transform: scale(1.1); color: #fff; }
    .score-label { font-size: 1.2em; margin-top: 5px; color: #8b949e; }
    
    #player-count { position: absolute; top: 10px; right: 10px; font-size: 1em; color: #8b949e; }

    /* BOUTON CELLULE */
    #cell-button {
      width: 220px; height: 220px;
      background: radial-gradient(circle, #2a5a2f 0%, var(--viral-green) 10%, #1e3f20 70%);
      border-radius: 50%; border: 4px solid var(--viral-green);
      box-shadow: 0 0 30px var(--viral-glow), inset 0 0 20px #1e3f20;
      cursor: pointer; transition: transform 0.05s, filter 0.2s;
      position: relative; z-index: 25;
    }
    #cell-button:active { transform: scale(0.95); }
    #cell-button.clicked { animation: cellClickAnim 0.1s; }
    @keyframes cellClickAnim { 0% { transform: scale(0.95); } 100% { transform: scale(1); } }

    /* PARTICULES */
    #particle-container, #passive-particle-container {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 15;
    }
    .particle {
      position: absolute; width: 8px; height: 8px; background: var(--viral-green);
      border-radius: 50%; animation: particleFly 1s forwards; opacity: 0;
    }
    .passive-particle {
      position: absolute; width: 4px; height: 4px; background: var(--viral-green);
      border-radius: 50%; animation: passiveFly 2s forwards; opacity: 0;
    }
    @keyframes particleFly { 
      0% { opacity: 1; transform: scale(1); } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); } 
    }
    @keyframes passiveFly {
      0% { opacity: 0.6; } 100% { opacity: 0; transform: translate(var(--tx), var(--ty)); }
    }

    /* ITEMS MAGASIN */
    h2 { color: var(--text-color); margin-bottom: 10px; padding-left: 5px; border-left: 3px solid var(--title-color); }
    
    .store-item {
      background-color: #21262d; border: 1px solid var(--border-color);
      border-radius: 5px; padding: 12px; cursor: pointer;
      display: flex; justify-content: space-between; align-items: center;
      transition: background 0.2s, border-color 0.2s;
    }
    .store-item:hover { background-color: #30363d; border-color: var(--title-color); }
    .store-item.purchased-anim { animation: flashGreen 0.3s; }
    .store-item.error-anim { animation: shakeRed 0.3s; }

    .item-info h3 { font-size: 1em; color: var(--text-color); }
    .item-desc { font-size: 0.8em; color: #8b949e; font-style: italic; margin-top: 2px; }
    .item-gain { font-size: 0.85em; color: var(--viral-green); margin-top: 2px; }
    .item-stats { text-align: right; min-width: 80px; }
    .item-cost { display: block; font-size: 1em; color: var(--viral-green); font-weight: bold; }
    .item-count { display: block; font-size: 1.4em; color: #fff; font-weight: bold; margin-top: 2px; }

    /* BOOSTS */
    #boost-area { 
      background: #21262d; border: 1px solid var(--border-color); border-radius: 5px; 
      padding: 10px; min-height: 60px; 
    }
    #boost-container { display: flex; flex-wrap: wrap; gap: 5px; }
    .boost-item {
      width: 45px; height: 45px; background: #30363d; border: 2px solid var(--title-color);
      border-radius: 50%; display: flex; align-items: center; justify-content: center;
      font-size: 1.5em; cursor: pointer; transition: transform 0.2s;
    }
    .boost-item:hover { transform: scale(1.1); border-color: var(--viral-green); }
    .boost-item.error-anim { animation: shakeRed 0.3s; }

    /* PRESTIGE */
    #prestige-area {
      display: none; background: #21262d; border: 1px solid var(--prestige-color);
      border-radius: 5px; padding: 10px; text-align: center;
    }
    #prestige-area h3 { color: var(--prestige-color); border: none; padding: 0; }
    .prestige-btn {
      background: var(--prestige-color); color: #000; border: none; padding: 8px;
      width: 100%; border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px;
      font-family: inherit;
    }
    .prestige-btn:hover { background: #ffd54f; }
    .prestige-btn.secondary { background: var(--title-color); color: white; }

    /* MODAL */
    #modal-backdrop {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 5000; justify-content: center; align-items: center;
    }
    #modal {
      width: 600px; max-height: 80vh; background: var(--bg-color); 
      border: 2px solid var(--prestige-color); border-radius: 10px;
      display: flex; flex-direction: column;
    }
    #modal-header { padding: 15px; border-bottom: 1px solid var(--border-color); text-align: center; }
    #modal-header h2 { color: var(--prestige-color); }
    #modal-body { padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    
    .p-upgrade {
      background: var(--panel-bg); border: 1px solid var(--border-color);
      padding: 10px; border-radius: 5px; cursor: pointer; display: flex; justify-content: space-between; align-items: center;
    }
    .p-upgrade:hover { background: #30363d; border-color: var(--prestige-color); }
    .p-upgrade.purchased { opacity: 0.5; cursor: default; border-color: var(--viral-green); }
    .p-upgrade.disabled { opacity: 0.5; cursor: not-allowed; }
    .p-upgrade.error-anim { animation: shakeRed 0.3s; }

    /* TOOLTIP */
    #tooltip {
      display: none; position: absolute; background: var(--panel-bg);
      border: 1px solid var(--title-color); padding: 10px; width: 220px;
      z-index: 9999; pointer-events: none; border-radius: 5px; box-shadow: 0 5px 20px #000;
    }
    #tooltip h4 { color: var(--title-color); margin-bottom: 5px; }
    #tooltip .cost { color: var(--viral-green); font-weight: bold; margin-bottom: 5px; }
    #tooltip .desc { color: #ccc; font-size: 0.9em; font-style: italic; }
    #tooltip .stats { margin-top: 5px; border-top: 1px solid #444; padding-top: 5px; font-size: 0.85em; color: #aaa; }

    /* ANIMATIONS */
    @keyframes flashGreen { 0% { background-color: var(--viral-green); } 100% { background-color: #21262d; } }
    @keyframes shakeRed { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); border-color: var(--error-color); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
  </style>
</head>
<body>

  <div id="background-cells">
    <div class="bg-cell" style="width:300px; height:300px; top:10%; left:10%;"></div>
    <div class="bg-cell" style="width:500px; height:500px; top:50%; left:60%;"></div>
  </div>
  
  <div id="passive-particle-container"></div>

  <div class="container">
    <div id="game-area">
      <h1>Laboratoire Viral (Collectif)</h1>
      <div id="player-count">Scientifiques : 0</div>
      
      <div class="score-panel">
        <div id="scoreDisplay">0</div>
        <p class="score-label">Cellules Infect√©es</p>
      </div>
      <div id="cell-button"></div>
      <div id="particle-container"></div>
    </div>

    <div id="store-area">
      <div id="prestige-area">
        <h3>Recherche Avanc√©e</h3>
        <p>+<span id="p-gain">0</span> PR au reset</p>
        <p>Total: <span id="p-total">0</span> PR</p>
        <button class="prestige-btn secondary" id="btn-meta">M√©ta-Recherche (üß†)</button>
        <button class="prestige-btn" id="btn-reset">Lancer la Mutation Globale</button>
      </div>

      <div id="boost-area">
        <h3>Recherche</h3>
        <div id="boost-container"></div>
      </div>

      <h2>Am√©liorations</h2>
      <div class="store-item" id="b-mutation">
        <div class="item-info"><h3>Mutation Mineure</h3><p class="item-desc">Ajustements d'ADN.</p><p class="item-gain">+0.1 CI/s</p></div>
        <div class="item-stats"><span class="item-cost">15</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-oiseau">
        <div class="item-info"><h3>Vecteur Oiseau</h3><p class="item-desc">Grippe 2.0.</p><p class="item-gain">+1 CI/s</p></div>
        <div class="item-stats"><span class="item-cost">100</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-eau">
        <div class="item-info"><h3>Contamination Eau</h3><p class="item-desc">Eau trouble.</p><p class="item-gain">+8 CI/s</p></div>
        <div class="item-stats"><span class="item-cost">1100</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-aerosol">
        <div class="item-info"><h3>Transmission A√©rosol</h3><p class="item-desc">Dans l'air.</p><p class="item-gain">+47 CI/s</p></div>
        <div class="item-stats"><span class="item-cost">12000</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-aeroport">
        <div class="item-info"><h3>A√©roport International</h3><p class="item-desc">Vols infect√©s.</p><p class="item-gain">+260 CI/s</p></div>
        <div class="item-stats"><span class="item-cost">130000</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-ferme">
        <div class="item-info"><h3>Fermes Virales</h3><p class="item-desc">Culture intensive.</p><p class="item-gain">+2k CI/s</p></div>
        <div class="item-stats"><span class="item-cost">500000</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-centre">
        <div class="item-info"><h3>Centres de Contagion</h3><p class="item-desc">Villes denses.</p><p class="item-gain">+15k CI/s</p></div>
        <div class="item-stats"><span class="item-cost">5M</span><span class="item-count">0</span></div>
      </div>
      <div class="store-item" id="b-propagande">
        <div class="item-info"><h3>Propagande Virale</h3><p class="item-desc">Fake news.</p><p class="item-gain">+100k CI/s</p></div>
        <div class="item-stats"><span class="item-cost">50M</span><span class="item-count">0</span></div>
      </div>
    </div>
  </div>

  <div id="tooltip"></div>

  <div id="modal-backdrop">
    <div id="modal">
      <div id="modal-header"><h2>M√©ta-Recherche</h2><p>Am√©liorations permanentes</p></div>
      <div id="modal-body"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    
    // ETAT CLIENT
    let lastState = null;
    let lastUpdate = Date.now();
    let displayedBoosts = new Set();
    let prestigeList = {};
    let currentScore = 0;

    // ELEMENTS
    const scoreEl = document.getElementById('scoreDisplay');
    const cellBtn = document.getElementById('cell-button');
    const tooltip = document.getElementById('tooltip');
    const partCont = document.getElementById('particle-container');
    const passPartCont = document.getElementById('passive-particle-container');
    const storeEl = document.getElementById('store-area');
    
    // MAPPINGS
    const builds = {
      'mutation_mineure': 'b-mutation', 'vecteur_oiseau': 'b-oiseau', 'contamination_eau': 'b-eau',
      'transmission_aerosol': 'b-aerosol', 'aeroport_international': 'b-aeroport', 'fermes_virales': 'b-ferme',
      'centres_contagion': 'b-centre', 'propagande_virale': 'b-propagande'
    };

    // TOOLTIP
    function showTip(e, title, cost, desc, gain, total, currency='CI') {
      let h = `<h4>${title}</h4><div class="cost" style="color:${currency==='PR'?'var(--prestige-color)':'var(--viral-green)'}">Co√ªt: ${Math.floor(cost).toLocaleString()} ${currency}</div><div class="desc">${desc}</div>`;
      if(gain) h += `<div class="stats">Gain: ${gain.toLocaleString()} CI/s<br>Total: ${total.toLocaleString()} CI/s</div>`;
      tooltip.innerHTML = h;
      tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px';
      tooltip.style.display = 'block';
    }
    function hideTip() { tooltip.style.display = 'none'; }
    function moveTip(e) { tooltip.style.left = (e.pageX+15)+'px'; tooltip.style.top = (e.pageY+15)+'px'; }

    // SETUP BATIMENTS (Event Listeners Statiques)
    for(let k in builds) {
      const el = document.getElementById(builds[k]);
      // Clic
      el.onclick = () => {
        if(!lastState) return;
        const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0);
        if(currentScore >= cost) {
          socket.emit('buy_upgrade', k);
          el.classList.add('purchased-anim'); setTimeout(()=>el.classList.remove('purchased-anim'),300);
        } else {
          el.classList.add('error-anim'); setTimeout(()=>el.classList.remove('error-anim'),300);
        }
      };
      // Hover
      el.onmouseenter = (e) => {
        if(!lastState) return;
        // Mapping moche mais n√©cessaire pour retrouver les cl√©s du state depuis l'ID HTML
        let stateKey = k; 
        if(k==='vecteur_oiseau') stateKey='vecteurs_oiseaux';
        if(k==='mutation_mineure') stateKey='mutations_mineures';
        // ... le serveur utilise des pluriels parfois, on adapte :
        const costKey = 'cost_' + k.split('_')[0].replace('vecteur','oiseau').replace('contamination','eau').replace('transmission','aerosol').replace('aeroport','aeroport').replace('fermes','ferme').replace('centres','centre').replace('propagande','propagande');
        const gainKey = costKey.replace('cost','gain');
        // Correction mapping simple:
        // server: mutations_mineures, cost_mutation, gain_mutation
        
        // Pour faire simple, on lit le DOM pour le titre et on chope les valeurs du state
        const name = el.querySelector('h3').innerText;
        const desc = el.querySelector('.item-desc').innerText;
        const cost = parseFloat(el.querySelector('.item-cost').dataset.raw);
        const gain = parseFloat(el.querySelector('.item-gain').dataset.raw);
        // Count
        let countKey = k;
        if(k=='mutation_mineure') countKey='mutations_mineures';
        if(k=='vecteur_oiseau') countKey='vecteurs_oiseaux';
        const count = lastState[countKey] || 0;
        
        showTip(e, name, cost, desc, gain, gain*count);
      };
      el.onmousemove = moveTip;
      el.onmouseleave = hideTip;
    }

    // CLIC CELLULE
    cellBtn.onclick = () => {
      socket.emit('click_cell');
      cellBtn.classList.add('clicked'); setTimeout(()=>cellBtn.classList.remove('clicked'),100);
      spawnParticle(cellBtn, 5);
    };

    // PRESTIGE
    document.getElementById('btn-reset').onclick = () => {
      if(confirm('Prestige ? Reset complet vs PR.')) socket.emit('do_prestige');
    };
    document.getElementById('btn-meta').onclick = () => {
      document.getElementById('modal-backdrop').style.display = 'flex';
      renderPrestigeShop();
    };
    document.getElementById('modal-backdrop').onclick = (e) => {
      if(e.target.id === 'modal-backdrop') e.target.style.display = 'none';
    };

    // SOCKET UPDATE (Tick - Score)
    socket.on('tick_update', (d) => {
      if(!lastState) return;
      lastState.totalInfectedCells = d.score;
      lastState.cellsPerSecond = d.cps;
      lastUpdate = Date.now();
      document.getElementById('player-count').innerText = 'Scientifiques: ' + d.players;
      const hue = Math.min(d.clickHeat*0.8, 120);
      cellBtn.style.filter = `hue-rotate(${hue}deg)`;
    });

    // SOCKET UPDATE (Full - Achats)
    socket.on('full_update', (d) => {
      lastState = d.gameState;
      lastUpdate = Date.now();
      prestigeUpgradesList = d.prestigeUpgrades;

      // Update B√¢timents UI
      const s = lastState;
      const update = (key, cKey, gKey, cntKey) => {
        const el = document.getElementById(builds[key]);
        const cost = s[cKey];
        const gain = s[gKey];
        const count = s[cntKey];
        
        el.querySelector('.item-cost').innerText = Math.floor(cost).toLocaleString();
        el.querySelector('.item-cost').dataset.raw = cost; // Stocker pour verification locale
        el.querySelector('.item-count').innerText = count;
        el.querySelector('.item-gain').innerText = `+${gain.toLocaleString()} CI/s`;
        el.querySelector('.item-gain').dataset.raw = gain;
      };
      
      update('mutation_mineure', 'cost_mutation', 'gain_mutation', 'mutations_mineures');
      update('vecteur_oiseau', 'cost_oiseau', 'gain_oiseau', 'vecteurs_oiseaux');
      update('contamination_eau', 'cost_eau', 'gain_eau', 'contamination_eau');
      update('transmission_aerosol', 'cost_aerosol', 'gain_aerosol', 'transmission_aerosol');
      update('aeroport_international', 'cost_aeroport', 'gain_aeroport', 'aeroport_international');
      update('fermes_virales', 'cost_ferme', 'gain_ferme', 'fermes_virales');
      update('centres_contagion', 'cost_centre', 'gain_centre', 'centres_contagion');
      update('propagande_virale', 'cost_propagande', 'gain_propagande', 'propagande_virale');

      // Update Boosts
      const boostCont = document.getElementById('boost-container');
      boostCont.innerHTML = ''; // Reset simple et s√ªr
      for(const b of d.availableBoosts) {
        const el = document.createElement('div');
        el.className = 'boost-item';
        // Emoji mapping simple
        let ico = '‚ùì';
        if(b.id.includes('seringue')) ico='üíâ'; else if(b.id.includes('clics')) ico='üñ±Ô∏è';
        else if(b.id.includes('mutation')) ico='üß¨'; else if(b.id.includes('plumes')||b.id.includes('oiseau')) ico='ü™∂';
        else if(b.id.includes('filtres')||b.id.includes('eau')) ico='üíß'; else if(b.id.includes('spores')||b.id.includes('aerosol')) ico='üí®';
        else if(b.id.includes('partenariats')||b.id.includes('aeroport')) ico='‚úàÔ∏è'; else if(b.id.includes('nutriments')||b.id.includes('ferme')) ico='üåø';
        else if(b.id.includes('gentrification')||b.id.includes('centre')) ico='üèôÔ∏è'; else if(b.id.includes('fake')||b.id.includes('propagande')) ico='üì∞';
        else if(b.id.includes('contamination')) ico='‚ò£Ô∏è';
        
        el.innerText = ico;
        
        // Clic Boost
        el.onclick = () => {
          let cost = b.cost;
          if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9;
          if(currentScore >= cost) {
            socket.emit('buy_boost', b.id);
            el.remove(); // Feedback instantan√©
          } else {
            el.classList.add('error-anim'); setTimeout(()=>el.classList.remove('error-anim'),300);
          }
        };
        
        // Hover Boost
        el.onmouseenter = (e) => {
           let cost = b.cost;
           if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9;
           showTip(e, b.name, cost, b.description); 
        };
        el.onmousemove = moveTip;
        el.onmouseleave = hideTip;
        
        // Stocker co√ªt pour la boucle
        let cost = b.cost;
        if(s.purchasedPrestigeUpgrades.includes('p_recherche_acceleree')) cost *= 0.9;
        el.dataset.cost = cost;
        
        boostCont.appendChild(el);
      }

      // Update Prestige UI
      const pInfo = d.prestigeInfo;
      const pArea = document.getElementById('prestige-area');
      if(pInfo.canPrestige || s.prestigePoints > 0) {
        pArea.style.display = 'block';
        document.getElementById('prestige-points-gain').innerText = pInfo.pointsOnReset.toLocaleString();
        document.getElementById('prestige-points-total').innerText = s.prestigePoints.toLocaleString();
      } else {
        pArea.style.display = 'none';
      }
      
      renderPrestigeShop();
    });

    function renderPrestigeShop() {
      if(!lastState) return;
      const body = document.getElementById('modal-body');
      body.innerHTML = '';
      for(const id in prestigeUpgradesList) {
        const u = prestigeUpgradesList[id];
        const row = document.createElement('div');
        row.className = 'p-upgrade';
        
        row.innerHTML = `<div><h4>${u.name}</h4><div class="description">${u.description}</div></div><div class="cost">${u.cost} PR</div>`;
        
        const isBought = lastState.purchasedPrestigeUpgrades.includes(id);
        const canBuy = lastState.prestigePoints >= u.cost;
        
        if(isBought) row.classList.add('purchased');
        else if(!canBuy) row.classList.add('disabled');
        
        row.onclick = () => {
          if(!isBought && canBuy) {
             socket.emit('buy_prestige_upgrade', id);
             row.classList.add('purchased'); // Feedback instantan√©
          } else if (!isBought) {
             row.classList.add('error-anim'); setTimeout(()=>row.classList.remove('error-anim'),300);
          }
        };
        
        body.appendChild(row);
      }
    }

    // PARTICULES
    function spawnParticle(src, n) {
      const rect = src.getBoundingClientRect();
      const dest = scoreDisplay.getBoundingClientRect();
      const area = gameArea.getBoundingClientRect(); // Relatif au container
      
      for(let i=0; i<n; i++) {
        const p = document.createElement('div'); p.className = 'particle';
        const s = Math.random()*8+4; p.style.width=s+'px'; p.style.height=s+'px';
        p.style.left = (rect.left - area.left + rect.width/2)+'px'; 
        p.style.top = (rect.top - area.top + rect.height/2)+'px';
        
        const tx = (dest.left - rect.left) + (Math.random()-0.5)*50;
        const ty = (dest.top - rect.top) + (Math.random()-0.5)*50;
        
        p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px');
        partCont.appendChild(p);
        setTimeout(()=>p.remove(), 1000);
      }
    }
    
    function spawnPassive() {
      const rect = storeEl.getBoundingClientRect();
      const dest = scoreDisplay.getBoundingClientRect();
      const p = document.createElement('div'); p.className='passive-particle';
      const s = Math.random()*3+2; p.style.width=s+'px'; p.style.height=s+'px';
      
      const startY = Math.random() * window.innerHeight;
      p.style.left = rect.left+'px'; p.style.top = startY+'px';
      
      const tx = dest.left - rect.left + 50;
      const ty = (dest.top + 20) - startY;
      
      p.style.setProperty('--tx', tx+'px'); p.style.setProperty('--ty', ty+'px');
      passPartCont.appendChild(p);
      setTimeout(()=>p.remove(), 2000);
    }

    // BOUCLE RENDU (60 FPS)
    function render() {
      if(lastState) {
        const delta = Date.now() - lastUpdate;
        const pred = lastState.totalInfectedCells + (lastState.cellsPerSecond/1000 * delta);
        currentScore = Math.floor(pred);
        scoreDisplay.innerText = currentScore.toLocaleString();
        
        // Check grisage B√¢timents
        for(let k in builds) {
          const el = document.getElementById(builds[k]);
          const cost = parseFloat(el.querySelector('.item-cost').dataset.raw || 0);
          el.style.opacity = (currentScore >= cost) ? 1 : 0.5;
          el.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed';
        }
        
        // Check grisage Boosts
        const bItems = document.getElementsByClassName('boost-item');
        for(let b of bItems) {
          const cost = parseFloat(b.dataset.cost);
          b.style.opacity = (currentScore >= cost) ? 1 : 0.5;
          b.style.cursor = (currentScore >= cost) ? 'pointer' : 'not-allowed';
        }
        
        // Particules passives
        if(lastState.cellsPerSecond > 0) {
          const chance = Math.log10(lastState.cellsPerSecond+1) * 0.05;
          if(Math.random() < chance) spawnPassive();
        }
      }
      requestAnimationFrame(render);
    }
    requestAnimationFrame(render);

  </script>
</body>
</html>